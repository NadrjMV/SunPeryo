<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SunPeryo - Painel Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        :root {
            --primary-blue: #0A3D62;
            --accent-blue: #2980B9;
            --light-bg: #F7F9FC;
            --text-primary: #1A202C;
            --text-secondary: #5A6A7B;
            --border-color: #E2E8F0;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--light-bg); }
        .desktop-nav-item.active { 
            color: var(--primary-blue); 
            background-color: #EFF6FF;
            font-weight: 600;
        }
        .logo-img { object-fit: contain; }
        .loader {
            width: 48px; height: 48px; border: 5px solid #d1d5db;
            border-bottom-color: var(--primary-blue); border-radius: 50%;
            display: inline-block; animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #qr-code-container canvas {
            width: 100% !important;
            height: auto !important;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body>
    <div id="loading-screen" class="h-screen flex flex-col justify-center items-center bg-white">
        <img src="https://i.postimg.cc/HngV6ftW/SUN-PLAN.png" alt="Logo Sun Plan" class="h-16 w-auto mb-4 logo-img">
        <span class="loader"></span>
        <p class="mt-4 text-lg font-medium text-[var(--text-secondary)]">Verificando permissões...</p>
    </div>

    <div id="admin-desktop-layout" class="hidden lg:flex">
        <div class="w-64 bg-white shadow-md h-screen fixed top-0 left-0 p-6 flex flex-col">
            <img src="https://i.postimg.cc/HngV6ftW/SUN-PLAN.png" alt="Logo Sun Plan" class="h-12 w-auto mb-8 logo-img">
            <nav id="admin-desktop-nav" class="flex-grow space-y-2"></nav>
            <button id="logout-button-desktop" class="flex items-center gap-3 p-3 rounded-lg text-red-600 hover:bg-red-50 font-semibold mt-auto">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                <span>Sair da Conta</span>
            </button>
        </div>
        <div class="flex-1 lg:ml-64">
            <header class="bg-white/90 backdrop-blur-sm text-[var(--text-primary)] p-4 flex justify-between items-center shadow-sm sticky top-0 z-20 border-b border-[var(--border-color)]">
                <h1 id="header-title-desktop" class="text-xl font-bold">Painel Admin</h1>
                <div id="desktop-user-info" class="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-gray-100"></div>
            </header>
            <main id="main-content-desktop" class="p-8"></main>
        </div>
    </div>
    
    <div id="mobile-unsupported" class="lg:hidden h-screen flex flex-col items-center justify-center text-center p-4">
        <img src="https://i.postimg.cc/HngV6ftW/SUN-PLAN.png" alt="Logo Sun Plan" class="h-16 w-auto mb-4 logo-img">
        <h2 class="text-2xl font-bold text-[var(--primary-blue)]">Painel de Admin</h2>
        <p class="text-[var(--text-secondary)] mt-2">Esta área foi projetada para uma tela maior. Por favor, acesse de um computador.</p>
        <button id="logout-button-mobile" class="mt-8 bg-red-500 text-white font-bold py-2 px-4 rounded-lg">Sair</button>
    </div>

    <div id="modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
        <div id="modal-content" class="bg-white text-[var(--text-primary)] rounded-xl shadow-xl w-full max-w-md max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-[var(--border-color)] flex justify-between items-center">
                <h3 id="modal-title" class="text-lg font-bold"></h3>
                <button id="modal-close-button" class="text-gray-400 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div id="modal-body" class="p-6 overflow-y-auto bg-[var(--light-bg)]"></div>
        </div>
    </div>
    
    <div id="toast" class="hidden fixed bottom-24 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-lg z-50">
        <p id="toast-message"></p>
    </div>
    
    <div id="screen-templates" class="hidden"></div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, collection, query, getDocs, setDoc, updateDoc, deleteDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { 
            apiKey: "AIzaSyAqBwCgVJR_fH_QisTQZiIJE9B-2JC93vk",
            authDomain: "sunperyo.firebaseapp.com",
            projectId: "sunperyo",
            storageBucket: "sunperyo.appspot.com", 
            messagingSenderId: "850650155716",
            appId: "1:850650155716:web:8bfb4799d92d701e421791"
        };
        const appId = "sunperyo-app";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userData, allUsers = [], checkpoints = [], mapInstance, screens = {}, modalStack = [];
        const mainContent = document.getElementById('main-content-desktop');
        const headerTitle = document.getElementById('header-title-desktop');
        const modalOverlay = document.getElementById('modal-overlay');

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists() && userDoc.data().role === 'admin') {
                    document.getElementById('loading-screen').classList.add('hidden');
                    document.getElementById('admin-desktop-layout').classList.remove('hidden');
                    await startAdminApp(user, userDoc.data());
                } else {
                    window.location.replace('guard.html');
                }
            } else {
                window.location.replace('index.html');
            }
        });
        
        async function startAdminApp(user, data) {
            userData = { id: user.uid, ...data };
            
            document.getElementById('desktop-user-info').innerHTML = `
                <div class="text-right">
                    <p class="font-semibold">${userData.name}</p>
                    <p class="text-sm text-gray-500">${userData.email}</p>
                </div>
                <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center font-bold text-[var(--primary-blue)] text-xl flex-shrink-0 ml-3">
                    ${(userData.name || 'U').charAt(0)}
                </div>
            `;

            initializeTemplates();
            updateNavigation();
            await loadCheckpoints();
            await loadUsers();
            navigateToScreen('adminDashboard', 'Painel Admin');
            loadAdminDashboard();

            document.getElementById('admin-desktop-nav').addEventListener('click', handleNavigation);
            document.getElementById('logout-button-desktop').addEventListener('click', () => signOut(auth));
            document.getElementById('logout-button-mobile').addEventListener('click', () => signOut(auth));
            document.getElementById('modal-close-button').addEventListener('click', closeModal);
            document.getElementById('modal-body').addEventListener('click', handleModalAction);
            document.getElementById('desktop-user-info').addEventListener('click', () => {
                openModal('Meu Perfil', null, {
                    renderer: (container) => loadProfile(container)
                });
            });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('[data-action="open-menu"]') && !e.target.closest('[id^=menu-]')) {
                    document.querySelectorAll('[id^=menu-]').forEach(menu => menu.classList.add('hidden'));
                }
            });
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    closeModal();
                }
            });
        }
        
        function initializeTemplates() {
            const templateContainer = document.getElementById('screen-templates');
            templateContainer.innerHTML = `
                <div id="admin-dashboard-screen"></div>
                <div id="admin-checkpoints-screen"></div>
                <div id="admin-reports-screen"></div>
                <div id="admin-alerts-screen"></div>
                <div id="profile-screen"></div>
            `;
            screens = {
                adminDashboard: document.getElementById('admin-dashboard-screen'),
                adminCheckpoints: document.getElementById('admin-checkpoints-screen'),
                adminReports: document.getElementById('admin-reports-screen'),
                adminAlerts: document.getElementById('admin-alerts-screen'),
                profile: document.getElementById('profile-screen'),
            };
        }
        
        function navigateToScreen(screenName, title) {
            Object.values(screens).forEach(s => s.classList.add('hidden'));
            if (screens[screenName]) {
                mainContent.innerHTML = '';
                mainContent.appendChild(screens[screenName]);
                screens[screenName].classList.remove('hidden');
                headerTitle.textContent = title;
            }
        }
        
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            toast.className = `fixed bottom-24 left-1/2 -translate-x-1/2 text-white px-6 py-3 rounded-full shadow-lg z-50 ${isError ? 'bg-red-600' : 'bg-gray-900'}`;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }
        
        function openModal(title, contentHtml, state = {}) {
            state.title = title;
            state.contentHtml = contentHtml;
            modalStack.push(state);
            renderCurrentModal();
        }

        function renderCurrentModal() {
            if (modalStack.length === 0) {
                modalOverlay.classList.add('hidden');
                if (mapInstance) {
                    mapInstance.remove();
                    mapInstance = null;
                }
                return;
            }
            
            const currentState = modalStack[modalStack.length - 1];
            document.getElementById('modal-title').textContent = currentState.title;
            const modalBody = document.getElementById('modal-body');

            if (currentState.renderer) {
                currentState.renderer(modalBody);
            } else {
                modalBody.innerHTML = currentState.contentHtml;
            }
            
            modalOverlay.classList.remove('hidden');
        }

        function closeModal() {
            if (modalStack.length > 0) {
                modalStack.pop();
                renderCurrentModal();
            }
        }

        function loadAdminDashboard() {
            screens.adminDashboard.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-xl shadow-md border border-[var(--border-color)]">
                        <p class="text-sm font-semibold text-[var(--text-secondary)]">Vigilantes</p>
                        <p id="admin-total-users" class="text-3xl font-extrabold text-[var(--primary-blue)]">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-md border border-[var(--border-color)]">
                        <p class="text-sm font-semibold text-[var(--text-secondary)]">Rondas Hoje</p>
                        <p id="admin-rounds-today" class="text-3xl font-extrabold text-[var(--primary-blue)]">0</p>
                    </div>
                </div>
                <h3 class="font-bold mb-2 text-[var(--text-secondary)] text-lg">Gerenciar Vigilantes</h3>
                <div class="relative mb-4">
                    <input id="search-user-input" type="text" placeholder="Buscar por nome ou email..." class="w-full pl-10 pr-4 py-3 rounded-lg bg-white text-[var(--text-primary)] border-2 border-transparent focus:border-[var(--accent-blue)] focus:ring-0 transition-all shadow-sm">
                    <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
                <div id="users-list" class="space-y-3"></div>`;
            screens.adminDashboard.querySelector('#search-user-input').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredUsers = allUsers.filter(user => user.email.toLowerCase().includes(searchTerm) || (user.name && user.name.toLowerCase().includes(searchTerm)));
                renderUsersList(filteredUsers);
            });
            loadAdminStats();
            renderUsersList(allUsers);
        }

        async function loadAdminStats() {
            const totalUsersEl = document.getElementById('admin-total-users');
            const roundsTodayEl = document.getElementById('admin-rounds-today');
            if(totalUsersEl) totalUsersEl.textContent = allUsers.length;

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            let totalRoundsToday = 0;
            const promises = allUsers.map(userDoc => {
                if (userDoc.role === 'guard') {
                    const roundsQuery = query(collection(db, `artifacts/${appId}/users/${userDoc.id}/rounds`), where("timestamp", ">=", today));
                    return getDocs(roundsQuery).then(snap => snap.size);
                }
                return Promise.resolve(0);
            });
            const results = await Promise.all(promises);
            totalRoundsToday = results.reduce((sum, count) => sum + count, 0);

            if(roundsTodayEl) roundsTodayEl.textContent = totalRoundsToday;
        }
        
        async function loadUsers() {
            try {
                const q = query(collection(db, `users`));
                const querySnapshot = await getDocs(q);
                allUsers = querySnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            } catch (error) {
                console.error("Erro ao carregar usuários:", error);
            }
        }
        
        function renderUsersList(users) {
            const usersListDiv = screens.adminDashboard.querySelector('#users-list');
            if (!usersListDiv) return;
            if (users.length === 0) {
                usersListDiv.innerHTML = '<p class="text-gray-500 text-center mt-8">Nenhum usuário encontrado.</p>';
                return;
            }
            usersListDiv.innerHTML = users.map(user => `
                <div class="bg-white p-4 rounded-xl flex justify-between items-center border border-[var(--border-color)] relative">
                    <div class="flex items-center gap-4 overflow-hidden">
                        <div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center font-bold text-[var(--primary-blue)] text-xl flex-shrink-0">
                            ${(user.name || 'U').charAt(0)}
                        </div>
                        <div class="overflow-hidden">
                            <p class="font-semibold text-[var(--text-primary)] truncate">${user.name || 'Nome não definido'}</p>
                            <p class="text-sm text-[var(--text-secondary)] truncate">${user.email}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                        <span class="text-xs font-bold uppercase px-2 py-1 rounded-full ${user.role === 'admin' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">${user.role}</span>
                        <button class="p-2 text-gray-500 hover:text-[var(--primary-blue)]" data-action="open-menu" data-userid="${user.id}">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path></svg>
                        </button>
                    </div>
                    <div id="menu-${user.id}" class="hidden absolute right-4 top-14 bg-white shadow-lg rounded-lg border border-gray-200 z-10 w-48">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-action="view-rounds" data-userid="${user.id}" data-username="${user.name}">Ver Rondas</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-action="edit-role" data-userid="${user.id}" data-username="${user.name}" data-currentrole="${user.role}">Editar Função</a>
                        <a href="#" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50" data-action="delete-user" data-userid="${user.id}" data-username="${user.name}">Excluir Usuário</a>
                    </div>
                </div>
            `).join('');
            usersListDiv.querySelectorAll('[data-action]').forEach(el => el.addEventListener('click', handleUserAction));
        }
        
        function handleUserAction(e) {
            e.stopPropagation(); 
            const target = e.target.closest('[data-action]');
            if (!target) return;
            const action = target.dataset.action;
            const userId = target.dataset.userid;
            const userName = target.dataset.username;
            document.querySelectorAll('[id^=menu-]').forEach(menu => {
                if (menu.id !== `menu-${userId}`) menu.classList.add('hidden');
            });
            if (action === 'open-menu') {
                document.getElementById(`menu-${userId}`).classList.toggle('hidden');
            }
            if (action === 'view-rounds') {
                openModal(`Rondas de ${userName}`, null, {
                    renderer: (container) => showRoundsForUser(userId, container),
                    userId: userId,
                    userName: userName
                });
            }
            if (action === 'edit-role') {
                const currentRole = target.dataset.currentrole;
                const newRole = currentRole === 'admin' ? 'guard' : 'admin';
                openModal('Editar Função', `
                    <p>Mudar a função de <strong>${userName}</strong> de <strong>${currentRole.toUpperCase()}</strong> para <strong>${newRole.toUpperCase()}</strong>?</p>
                    <div class="mt-6 flex justify-end gap-3">
                        <button id="cancel-edit-btn" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">Cancelar</button>
                        <button id="confirm-edit-btn" data-userid="${userId}" data-newrole="${newRole}" class="px-4 py-2 rounded-lg bg-[var(--primary-blue)] text-white hover:bg-[var(--accent-blue)]">Confirmar</button>
                    </div>
                `);
            }
            if (action === 'delete-user') {
                 openModal('Excluir Usuário', `
                    <p>Tem certeza que deseja excluir <strong>${userName}</strong>? Esta ação não pode ser desfeita.</p>
                    <p class="text-sm text-red-600 mt-2">Atenção: Isso removerá o usuário do banco de dados do app, mas não da autenticação do Firebase.</p>
                    <div class="mt-6 flex justify-end gap-3">
                        <button id="cancel-delete-btn" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">Cancelar</button>
                        <button id="confirm-delete-btn" data-userid="${userId}" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700">Excluir</button>
                    </div>
                `);
            }
        }

        function handleModalAction(e) {
            const target = e.target;
            if (target.id === 'cancel-edit-btn' || target.id === 'cancel-delete-btn' || target.id === 'cancel-checkpoint-btn' || target.id === 'close-qr-modal-btn') closeModal();
            if (target.id === 'confirm-edit-btn') {
                const { userid, newrole } = target.dataset;
                try {
                    updateDoc(doc(db, "users", userid), { role: newrole });
                    showToast("Função atualizada com sucesso!");
                    loadUsers().then(() => renderUsersList(allUsers));
                    closeModal();
                } catch (err) { showToast("Erro ao atualizar função.", true); }
            }
            if (target.id === 'confirm-delete-btn') {
                const { userid } = target.dataset;
                try {
                    deleteDoc(doc(db, "users", userid));
                    showToast("Usuário excluído com sucesso!");
                    loadUsers().then(() => renderUsersList(allUsers));
                    closeModal();
                } catch (err) { showToast("Erro ao excluir usuário.", true); }
            }
            if (target.id === 'save-checkpoint-btn') {
                const name = document.getElementById('checkpoint-name-input').value;
                const qrContent = document.getElementById('checkpoint-qr-input').value;
                if (!name || !qrContent) { showToast("Preencha todos os campos.", true); return; }
                try {
                    addDoc(collection(db, `artifacts/${appId}/public/data/checkpoints`), { name, qrContent });
                    showToast("Ponto de verificação salvo!");
                    loadCheckpoints();
                    closeModal();
                    setTimeout(() => {
                        displayGeneratedQRCode(name, qrContent);
                    }, 350);
                } catch(err) { showToast("Erro ao salvar ponto.", true); }
            }
        }

        async function showRoundsForUser(userId, container) {
            container.innerHTML = '<div class="flex justify-center items-center p-8"><span class="loader"></span></div>';
            try {
                const q = query(collection(db, `artifacts/${appId}/users/${userId}/rounds`));
                const querySnapshot = await getDocs(q);
                if(querySnapshot.empty) {
                    container.innerHTML = '<p class="text-center text-gray-500">Nenhuma ronda encontrada.</p>';
                    return;
                }
                const roundsByDate = {};
                querySnapshot.forEach(doc => {
                    const round = { id: doc.id, ...doc.data() };
                    const date = round.timestamp.toDate().toLocaleDateString('pt-BR', { year: 'numeric', month: 'long', day: 'numeric' });
                    if (!roundsByDate[date]) roundsByDate[date] = [];
                    roundsByDate[date].push(round);
                });
                let datesHtml = '<div class="space-y-2">';
                const sortedDates = Object.keys(roundsByDate).sort((a, b) => new Date(b.split(' de ')[2], b.split(' de ')[1], b.split(' de ')[0]) - new Date(a.split(' de ')[2], a.split(' de ')[1], a.split(' de ')[0]));
                for (const date of sortedDates) {
                    datesHtml += `
                        <div class="bg-white p-4 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors border border-[var(--border-color)]" data-date-key="${date}">
                           <p class="font-semibold text-[var(--text-primary)] flex justify-between items-center">${date} <span class="text-sm font-normal text-white bg-[var(--primary-blue)] px-2 py-0.5 rounded-full">${roundsByDate[date].length}</span></p>
                        </div>
                    `;
                }
                datesHtml += '</div>';
                container.innerHTML = datesHtml;
                container.querySelectorAll('[data-date-key]').forEach(el => {
                    el.addEventListener('click', () => {
                        const dateKey = el.dataset.dateKey;
                        const state = modalStack[modalStack.length - 1];
                        openModal(`Registros de ${dateKey}`, null, {
                            renderer: (container) => showRoundsForDate(container, dateKey, roundsByDate[dateKey]),
                            userName: state.userName,
                        });
                    });
                });
            } catch (error) {
                container.innerHTML = `<p class="text-center text-red-500">Erro ao carregar rondas.</p>`;
            }
        }
        
        function showRoundsForDate(container, date, rounds) {
            rounds.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);
            let timesHtml = '<div class="space-y-2">';
            rounds.forEach((round, index) => {
                const time = round.timestamp.toDate().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                const typeIcon = round.photoBase64 
                    ? `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="text-blue-600"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 0 1 2-2h.93a2 2 0 0 0 1.664-.89l.812-1.22A2 2 0 0 1 10.07 4h3.86a2 2 0 0 1 1.664.89l.812 1.22A2 2 0 0 0 18.07 7H19a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9Z"></path><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"></path></svg>` 
                    : `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="text-purple-600"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V6a2 2 0 0 1 2-2h2M4 16v2a2 2 0 0 0 2 2h2m8-12h2a2 2 0 0 1 2 2v2m-4 8h2a2 2 0 0 0 2-2v-2M7 12h10"></path></svg>`;
                const details = round.checkpointName || (round.photoBase64 ? 'Foto do Local' : `QR: ${round.qrData}`);
                timesHtml += `
                    <button class="w-full bg-white p-3 rounded-lg flex justify-between items-center border border-[var(--border-color)] text-left hover:bg-gray-50" data-round-index="${index}">
                        <div class="flex items-center gap-3">
                            ${typeIcon}
                            <div>
                                <p class="font-bold text-[var(--text-primary)]">${time}</p>
                                <p class="text-sm text-[var(--text-secondary)]">${details}</p>
                            </div>
                        </div>
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                `;
            });
            timesHtml += '</div>';
            timesHtml += `<button id="view-day-summary" class="w-full mt-6 bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition-colors">Ver Resumo do Dia no Mapa</button>`;
            container.innerHTML = timesHtml;
            container.querySelectorAll('[data-round-index]').forEach(el => {
                el.addEventListener('click', () => {
                    const round = rounds[parseInt(el.dataset.roundIndex)];
                    if (round.photoBase64) {
                        openModal('Foto da Ronda', `<img src="${round.photoBase64}" class="w-full h-auto rounded-lg shadow-md">`);
                    } else {
                        openModal('Detalhe da Ronda', `<p class="text-[var(--text-secondary)]">Registro de QR Code:</p><p class="font-bold text-2xl mt-1">${round.qrData}</p>`);
                    }
                });
            });
            container.querySelector('#view-day-summary').addEventListener('click', () => {
                 const state = modalStack[modalStack.length - 1];
                 openModal(`Resumo de ${date}`, null, {
                    renderer: (container) => showDaySummary(container, date, rounds),
                    userName: state.userName
                });
            });
        }

        function showDaySummary(container, date, rounds) {
            let summaryHtml = '<div class="space-y-4">';
            summaryHtml += '<div><h4 class="font-bold mb-2">Mapa de Calor da Ronda</h4><div id="heatmap-container" class="bg-gray-200 h-64 w-full rounded-lg"></div></div>';
            const photos = rounds.filter(r => r.photoBase64);
            if(photos.length > 0) {
                summaryHtml += `
                    <div>
                        <div class="flex justify-between items-center">
                            <h4 class="font-bold mb-2">Fotos do Dia</h4>
                            <button id="download-zip-btn" class="bg-green-600 text-white text-xs font-bold px-3 py-1 rounded-lg hover:bg-green-700 transition-colors">Baixar Todas (.zip)</button>
                        </div>
                        <div id="photo-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-2 mt-2">`;
                photos.forEach((p, index) => {
                    summaryHtml += `<img src="${p.photoBase64}" class="w-full h-32 object-cover rounded-lg shadow-md hover:opacity-80 transition-opacity cursor-pointer" data-photo-index="${index}">`;
                });
                summaryHtml += '</div></div>';
            }
            summaryHtml += '</div>';
            container.innerHTML = summaryHtml;
            container.querySelectorAll('[data-photo-index]').forEach(el => {
                el.addEventListener('click', () => {
                    const photo = photos[parseInt(el.dataset.photoIndex)];
                    openModal('Foto da Ronda', `<img src="${photo.photoBase64}" class="w-full h-auto rounded-lg">`);
                });
            });

            if (photos.length > 0) {
                container.querySelector('#download-zip-btn').addEventListener('click', async () => {
                    const state = modalStack[modalStack.length - 1];
                    const zip = new JSZip();
                    showToast('Preparando arquivo .zip...');
                    const photoPromises = photos.map(async (photo, index) => {
                        const response = await fetch(photo.photoBase64);
                        const blob = await response.blob();
                        zip.file(`foto-${index + 1}.jpg`, blob);
                    });
                    await Promise.all(photoPromises);
                    zip.generateAsync({type:"blob"}).then(function(content) {
                        const link = document.createElement('a');
                        const safeDate = date.replace(/[^a-z0-9]/gi, '-');
                        link.href = URL.createObjectURL(content);
                        link.download = `Ronda-${state.userName}-${safeDate}.zip`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        showToast('Download iniciado!');
                    });
                });
            }

            const locations = rounds.filter(r => r.latitude && r.longitude).map(r => [r.latitude, r.longitude, 0.8]);
            if (locations.length > 0) {
                const center = locations[0];
                setTimeout(() => {
                    try {
                        const mapContainer = document.getElementById('heatmap-container');
                        if (mapContainer && !mapContainer._leaflet_id) {
                           mapInstance = L.map('heatmap-container').setView([center[0], center[1]], 15);
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                            }).addTo(mapInstance);
                            L.heatLayer(locations, {radius: 25, blur: 15, maxZoom: 17}).addTo(mapInstance);
                        }
                    } catch(e) {
                        console.error("Map rendering error:", e);
                        document.getElementById('heatmap-container').innerHTML = `<p class="text-red-500 p-4">Erro ao renderizar o mapa.</p>`;
                    }
                }, 100);
            } else {
                document.getElementById('heatmap-container').innerHTML = '<p class="text-gray-500 p-4 text-center">Nenhum dado de localização para exibir no mapa.</p>';
            }
        }

        async function loadCheckpoints() {
            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/checkpoints`));
                const querySnapshot = await getDocs(q);
                checkpoints = querySnapshot.docs.map(d => ({id: d.id, ...d.data()}));
            } catch (e) {
                console.error("Error loading checkpoints:", e);
            }
        }

        function renderCheckpoints() {
            const screen = screens.adminCheckpoints;
            screen.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-[var(--text-secondary)] text-lg">Pontos de Verificação</h3>
                    <button id="add-checkpoint-btn" class="bg-[var(--primary-blue)] text-white font-bold px-4 py-2 rounded-lg hover:bg-[var(--accent-blue)] transition-all text-sm">Novo Ponto</button>
                </div>
                <div id="checkpoints-list" class="space-y-3"></div>`;
            const listDiv = screen.querySelector('#checkpoints-list');
            if (checkpoints.length === 0) {
                listDiv.innerHTML = '<p class="text-center text-gray-500 p-4">Nenhum ponto de verificação criado.</p>';
            } else {
                listDiv.innerHTML = checkpoints.map(c => `
                    <div class="bg-white p-4 rounded-xl flex justify-between items-center border border-[var(--border-color)]">
                        <div>
                            <p class="font-semibold text-[var(--text-primary)]">${c.name}</p>
                            <p class="text-sm text-[var(--text-secondary)]">QR: ${c.qrContent}</p>
                        </div>
                        <button data-action="delete-checkpoint" data-id="${c.id}" class="p-2 text-red-500 hover:bg-red-100 rounded-full">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                `).join('');
            }
            screen.querySelector('#add-checkpoint-btn').addEventListener('click', () => {
                openModal('Novo Ponto de Verificação', `
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium text-[var(--text-secondary)]">Nome do Ponto</label>
                            <input id="checkpoint-name-input" type="text" placeholder="Ex: Portaria Principal" class="w-full mt-1 px-4 py-3 rounded-lg bg-white text-[var(--text-primary)] border-2 border-transparent focus:border-[var(--accent-blue)] focus:ring-0 transition-all shadow-sm">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-[var(--text-secondary)]">Texto do QR Code</label>
                            <input id="checkpoint-qr-input" type="text" placeholder="Ex: PONTO_01" class="w-full mt-1 px-4 py-3 rounded-lg bg-white text-[var(--text-primary)] border-2 border-transparent focus:border-[var(--accent-blue)] focus:ring-0 transition-all shadow-sm">
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end gap-3">
                        <button id="cancel-checkpoint-btn" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">Cancelar</button>
                        <button id="save-checkpoint-btn" class="px-4 py-2 rounded-lg bg-[var(--primary-blue)] text-white hover:bg-[var(--accent-blue)]">Salvar e Gerar QR</button>
                    </div>
                `);
            });
            screen.querySelector('#checkpoints-list').addEventListener('click', handleCheckpointAction);
        }

        async function handleCheckpointAction(e) {
            const target = e.target.closest('[data-action="delete-checkpoint"]');
            if (target) {
                const checkpointId = target.dataset.id;
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/checkpoints`, checkpointId));
                    showToast("Ponto excluído com sucesso!");
                    await loadCheckpoints();
                } catch (err) { showToast("Erro ao excluir ponto.", true); }
            }
        }

        function displayGeneratedQRCode(name, qrContent) {
            openModal(`QR Code para: ${name}`, `
                <div class="flex flex-col items-center text-center">
                    <div id="qr-code-container" class="p-4 bg-white rounded-lg shadow-inner w-full max-w-xs"></div>
                    <p class="text-sm text-gray-500 mt-4">Use o botão abaixo para salvar a imagem.</p>
                    <div class="mt-6 flex gap-3 w-full">
                        <button id="close-qr-modal-btn" class="w-1/2 px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">Fechar</button>
                        <button id="download-qr-btn" class="w-1/2 bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition-colors">Baixar</button>
                    </div>
                </div>
            `);
            
            const typeNumber = 4;
            const errorCorrectionLevel = 'L';
            const qr = qrcode(typeNumber, errorCorrectionLevel);
            qr.addData(qrContent);
            qr.make();
            
            const qrContainer = document.getElementById('qr-code-container');
            qrContainer.innerHTML = qr.createImgTag(6, 12);
            qrContainer.firstChild.classList.add('w-full', 'h-auto');

            document.getElementById('download-qr-btn').addEventListener('click', () => {
                const canvas = document.createElement('canvas');
                const finalSize = 512;
                canvas.width = finalSize;
                canvas.height = finalSize;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, finalSize, finalSize);
                const qrCanvas = qrContainer.querySelector('canvas');
                const qrSize = finalSize * 0.8;
                const qrOffset = (finalSize - qrSize) / 2;
                ctx.drawImage(qrCanvas, qrOffset, qrOffset, qrSize, qrSize);
                const logo = new Image();
                logo.crossOrigin = "Anonymous";
                logo.src = 'https://i.postimg.cc/HngV6ftW/SUN-PLAN.png';
                logo.onload = () => {
                    const logoSize = finalSize * 0.2;
                    const logoOffset = (finalSize - logoSize) / 2;
                    ctx.fillStyle = 'white';
                    ctx.fillRect(logoOffset - 5, logoOffset - 5, logoSize + 10, logoSize + 10);
                    ctx.drawImage(logo, logoOffset, logoOffset, logoSize, logoSize);
                    const link = document.createElement('a');
                    link.download = `QRCode-${name.replace(/\s+/g, '-')}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                };
            });
        }

        function updateNavigation() {
            const navContainer = document.getElementById('admin-desktop-nav');
            const navItems = `
                <a href="#" data-nav="adminDashboard" class="desktop-nav-item flex items-center gap-4 p-3 rounded-lg hover:bg-gray-100 text-[var(--text-secondary)] font-semibold">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <span>Painel</span>
                </a>
                <a href="#" data-nav="adminCheckpoints" class="desktop-nav-item flex items-center gap-4 p-3 rounded-lg hover:bg-gray-100 text-[var(--text-secondary)] font-semibold">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V6a2 2 0 0 1 2-2h2M4 16v2a2 2 0 0 0 2 2h2m8-12h2a2 2 0 0 1 2 2v2m-4 8h2a2 2 0 0 0 2-2v-2M7 12h10"></path></svg>
                    <span>Pontos</span>
                </a>
                <a href="#" data-nav="adminReports" class="desktop-nav-item flex items-center gap-4 p-3 rounded-lg hover:bg-gray-100 text-[var(--text-secondary)] font-semibold">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    <span>Relatórios</span>
                </a>
                <a href="#" data-nav="adminAlerts" class="desktop-nav-item flex items-center gap-4 p-3 rounded-lg hover:bg-gray-100 text-[var(--text-secondary)] font-semibold">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.636 5.636a9 9 0 0112.728 0m-12.728 0l12.728 12.728"></path></svg>
                    <span>Alertas</span>
                </a>
                <a href="#" data-nav="profile" class="desktop-nav-item flex items-center gap-4 p-3 rounded-lg hover:bg-gray-100 text-[var(--text-secondary)] font-semibold">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    <span>Meu Perfil</span>
                </a>
            `;
            navContainer.innerHTML = navItems;
        }

        function handleNavigation(e) {
            e.preventDefault();
            const target = e.target.closest('[data-nav]');
            if (!target) return;
            const navTarget = target.dataset.nav;
            document.querySelectorAll('.desktop-nav-item').forEach(item => item.classList.remove('active'));
            target.classList.add('active');
            
            const screenMap = {
                profile: { screen: 'profile', title: 'Meu Perfil', load: () => loadProfile(mainContent) },
                adminDashboard: { screen: 'adminDashboard', title: 'Painel Admin', load: loadAdminDashboard },
                adminCheckpoints: { screen: 'adminCheckpoints', title: 'Pontos de Verificação', load: renderCheckpoints },
                adminReports: { screen: 'adminReports', title: 'Relatórios', load: loadReports },
                adminAlerts: { screen: 'adminAlerts', title: 'Central de Alertas', load: loadAlertsScreen },
            };
            
            if (screenMap[navTarget]) {
                const { screen, title, load } = screenMap[navTarget];
                navigateToScreen(screen, title);
                if (load) load();
            }
        }

        function loadProfile(container) {
            container.innerHTML = `
                <div class="space-y-6 max-w-md mx-auto">
                    <div>
                        <label class="text-sm font-medium text-[var(--text-secondary)]">Nome Completo</label>
                        <input id="profile-name-input" type="text" class="w-full mt-1 px-4 py-3 rounded-lg bg-white text-[var(--text-primary)] border-2 border-transparent focus:border-[var(--accent-blue)] focus:ring-0 transition-all shadow-sm">
                    </div>
                     <div>
                        <label class="text-sm font-medium text-[var(--text-secondary)]">Email</label>
                        <p id="profile-email-display" class="w-full mt-1 px-4 py-3 text-gray-600 bg-gray-100 rounded-lg"></p>
                    </div>
                     <div>
                        <label class="text-sm font-medium text-[var(--text-secondary)]">Função</label>
                        <p id="profile-role-display" class="w-full mt-1 px-4 py-3 text-gray-600 bg-gray-100 rounded-lg capitalize"></p>
                    </div>
                </div>
                <button id="save-profile-button" class="w-full mt-8 bg-[var(--primary-blue)] text-white font-bold py-3 rounded-lg hover:bg-[var(--accent-blue)] transition-colors max-w-md mx-auto block">Salvar Alterações</button>`;
            
            container.querySelector('#profile-name-input').value = userData.name || '';
            container.querySelector('#profile-email-display').textContent = userData.email;
            container.querySelector('#profile-role-display').textContent = userData.role;
            container.querySelector('#save-profile-button').addEventListener('click', async () => {
                const newName = container.querySelector('#profile-name-input').value;
                if (newName && newName !== userData.name) {
                    try {
                        const userDocRef = doc(db, "users", userData.id);
                        await updateDoc(userDocRef, { name: newName });
                        userData.name = newName;
                        showToast("Perfil atualizado com sucesso!");
                        startAdminApp(auth.currentUser, userData);
                    } catch (error) { showToast("Erro ao atualizar perfil.", true); }
                }
            });
        }

        async function loadReports() {
            screens.adminReports.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md border border-[var(--border-color)]">
                    <h3 class="font-bold text-lg text-[var(--text-primary)] mb-4">Resumo Geral</h3>
                    <div id="reports-content" class="space-y-3">
                        <div class="flex justify-between items-center py-2 border-b"><span>Total de Vigilantes:</span><span class="font-bold text-lg">${allUsers.length}</span></div>
                        <div class="flex justify-between items-center py-2 border-b"><span>Total de Pontos Cadastrados:</span><span class="font-bold text-lg">${checkpoints.length}</span></div>
                        <div class="flex justify-between items-center py-2"><span>Rondas Realizadas Hoje:</span><span id="report-rounds-today" class="font-bold text-lg"><div class="loader" style="width:20px;height:20px;border-width:3px;"></div></span></div>
                    </div>
                </div>`;
            await loadAdminStats();
        }

        async function loadAlertsScreen() {
            screens.adminAlerts.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md border border-[var(--border-color)]">
                    <h3 class="font-bold text-lg text-[var(--text-primary)] mb-1">Enviar Novo Alerta</h3>
                    <p class="text-[var(--text-secondary)] mb-4 text-sm">A mensagem será enviada para todos os vigilantes.</p>
                    <textarea id="alert-message-input" class="w-full p-3 rounded-lg bg-gray-100 border-2 border-transparent focus:border-[var(--accent-blue)] focus:ring-0" rows="4" placeholder="Digite sua mensagem aqui..."></textarea>
                    <button id="send-alert-btn" class="w-full mt-4 bg-[var(--primary-blue)] text-white font-bold py-3 rounded-lg hover:bg-[var(--accent-blue)] transition-colors">Enviar Alerta</button>
                </div>
            `;
            screens.adminAlerts.querySelector('#send-alert-btn').addEventListener('click', sendAlert);
        }

        async function sendAlert() {
            const messageInput = document.getElementById('alert-message-input');
            const message = messageInput.value.trim();
            if (!message) {
                showToast("A mensagem não pode estar vazia.", true);
                return;
            }
            try {
                await setDoc(doc(db, `artifacts/${appId}/public/data/alerts`, "latest"), {
                    message: message,
                    timestamp: new Date()
                });
                showToast("Alerta enviado com sucesso!");
                messageInput.value = '';
            } catch (error) {
                showToast("Erro ao enviar alerta.", true);
            }
        }
    </script>
</body>
</html>