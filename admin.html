<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SunPeryo - Painel Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        :root {
            --primary-blue: #0A3D62;
            --accent-blue: #2980B9;
            --light-bg: #F7F9FC;
            --text-primary: #1A202C;
            --text-secondary: #5A6A7B;
            --border-color: #E2E8F0;
        }
        html, body {
            position: fixed;
            overflow: hidden;
            width: 100%;
            height: 100%;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--light-bg); }
        .nav-item.active {
            color: var(--primary-blue);
            background-color: #EFF6FF;
            font-weight: 600;
        }
        .bottom-nav-item.active svg, .bottom-nav-item.active span {
            color: var(--primary-blue);
        }
        .logo-img { object-fit: contain; }
        .loader {
            width: 48px; height: 48px; border: 5px solid #d1d5db;
            border-bottom-color: var(--primary-blue); border-radius: 50%;
            display: inline-block; animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #app-shell, #admin-app-container {
            height: 100vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        #main-content-mobile { padding-bottom: 10rem; }
    </style>
</head>
<body>
    <div id="loading-screen" class="h-screen flex flex-col justify-center items-center bg-white">
        <img src="https://i.postimg.cc/HngV6ftW/SUN-PLAN.png" alt="Logo Sun Plan" class="h-16 w-auto mb-4 logo-img">
        <span class="loader"></span>
        <p class="mt-4 text-lg font-medium text-[var(--text-secondary)]">Verificando permissões...</p>
    </div>

    <div id="auth-message-screen" class="hidden h-screen flex flex-col justify-center items-center bg-white p-4 text-center">
        <img src="https://i.postimg.cc/HngV6ftW/SUN-PLAN.png" alt="Logo Sun Plan" class="h-16 w-auto mb-4 logo-img">
        <p id="auth-message-text" class="text-lg font-medium text-[var(--text-secondary)]"></p>
    </div>

    <div id="admin-app-container" class="hidden">
        <div id="admin-desktop-layout" class="hidden lg:flex">
            <div class="w-72 bg-white shadow-md h-screen fixed top-0 left-0 p-6 flex flex-col">
                <img src="https://i.postimg.cc/HngV6ftW/SUN-PLAN.png" alt="Logo Sun Plan" class="h-12 w-auto mb-8 logo-img">
                <nav id="admin-desktop-nav" class="flex-grow space-y-2"></nav>
                <button id="logout-button-desktop" class="flex items-center gap-3 p-3 rounded-lg text-red-600 hover:bg-red-50 font-semibold mt-auto">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    <span>Sair da Conta</span>
                </button>
            </div>
            <div class="flex-1 lg:ml-72">
                <header class="bg-white/90 backdrop-blur-sm text-[var(--text-primary)] p-4 flex justify-between items-center shadow-sm sticky top-0 z-20 border-b border-[var(--border-color)] h-20">
                    <h1 id="header-title-desktop" class="text-xl font-bold">Painel Admin</h1>
                    <div id="desktop-user-info" class="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-gray-100"></div>
                </header>
                <main id="main-content-desktop" class="p-8"></main>
            </div>
        </div>

        <div id="admin-mobile-layout" class="lg:hidden">
            <div id="app-shell" class="max-w-lg mx-auto bg-[var(--light-bg)] min-h-screen shadow-2xl relative">
                <header class="bg-white/90 backdrop-blur-sm text-[var(--text-primary)] p-4 flex justify-between items-center shadow-sm fixed top-0 w-full max-w-lg z-20 h-16">
                    <button id="menu-button-mobile" class="p-2 text-[var(--text-secondary)] hover:text-[var(--primary-blue)]">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <h1 id="header-title-mobile" class="text-xl font-bold">Painel Admin</h1>
                    <div class="w-10"></div>
                </header>
                <main id="main-content-mobile" class="pt-20 px-5"></main>
                <div id="menu-overlay" class="hidden fixed inset-0 bg-black bg-opacity-60 z-30"></div>
                <div id="side-menu-mobile" class="transition-transform transform -translate-x-full fixed top-0 left-0 h-full w-72 bg-white shadow-2xl z-40 p-6 flex flex-col text-[var(--text-primary)]">
                    <div id="mobile-user-info" class="mb-8"></div>
                    <nav id="admin-mobile-nav" class="flex-grow space-y-2"></nav>
                    <button id="logout-button-mobile" class="flex items-center gap-3 p-3 rounded-lg text-red-600 hover:bg-red-50 font-semibold mt-auto">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        <span>Sair da Conta</span>
                    </button>
                </div>
                <nav id="bottom-nav" class="hidden fixed bottom-0 w-full max-w-lg bg-white/90 backdrop-blur-sm border-t border-[var(--border-color)] grid grid-cols-5 text-center text-[var(--text-secondary)] z-20"></nav>
            </div>
        </div>
    </div>

    <div id="modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
        <div id="modal-content" class="bg-white text-[var(--text-primary)] rounded-xl shadow-xl w-full max-w-md max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-[var(--border-color)] flex justify-between items-center">
                <h3 id="modal-title" class="text-lg font-bold"></h3>
                <button id="modal-close-button" class="text-gray-400 hover:text-gray-800 text-3xl leading-none">×</button>
            </div>
            <div id="modal-body" class="p-6 overflow-y-auto bg-[var(--light-bg)]"></div>
        </div>
    </div>

    <div id="toast" class="hidden fixed bottom-24 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-lg z-50">
        <p id="toast-message"></p>
    </div>

    <div id="screen-templates" class="hidden"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, collection, query, getDocs, setDoc, updateDoc, deleteDoc, where, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyAqBwCgVJR_fH_QisTQZiIJE9B-2JC93vk",
            authDomain: "sunperyo.firebaseapp.com",
            projectId: "sunperyo",
            storageBucket: "sunperyo.appspot.com",
            messagingSenderId: "850650155716",
            appId: "1:850650155716:web:8bfb4799d92d701e421791"
        };
        const appId = "sunperyo-app";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userData, allUsers = [], patrols = [], checkpoints = [], mapInstance, screens = {}, modalStack = [];
        let uiInitialized = false;
        
        const mainContentDesktop = document.getElementById('main-content-desktop');
        const mainContentMobile = document.getElementById('main-content-mobile');
        const headerTitleDesktop = document.getElementById('header-title-desktop');
        const headerTitleMobile = document.getElementById('header-title-mobile');
        const modalOverlay = document.getElementById('modal-overlay');
        const sideMenuMobile = document.getElementById('side-menu-mobile');
        const menuOverlay = document.getElementById('menu-overlay');

        /**
         * ALTERAÇÃO: A lógica de autenticação agora redireciona o usuário para a página
         * de login (`index.html`) quando a sessão é encerrada, em vez de mostrar uma mensagem.
         */
        onAuthStateChanged(auth, async (user) => {
            const showAuthMessage = (message) => {
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('admin-app-container').classList.add('hidden');
                const messageScreen = document.getElementById('auth-message-screen');
                document.getElementById('auth-message-text').textContent = message;
                messageScreen.classList.remove('hidden');
            };

            const redirectTo = (page) => {
                try {
                    const currentPath = window.location.pathname;
                    const newPath = currentPath.substring(0, currentPath.lastIndexOf('/') + 1) + page;
                    window.location.replace(newPath);
                } catch (e) {
                    console.error("Falha ao redirecionar:", e);
                    showAuthMessage(`Sessão encerrada. Por favor, retorne para a página de login.`);
                }
            };

            if (user) {
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        if (userData.role === 'admin') {
                            document.getElementById('loading-screen').classList.add('hidden');
                            document.getElementById('admin-app-container').classList.remove('hidden');
                            document.getElementById('auth-message-screen').classList.add('hidden');
                            await startAdminApp(user, userData);
                        } else {
                            redirectTo('guard.html');
                        }
                    } else {
                        console.error("Estado inconsistente: Usuário existe na Auth mas não no Firestore. Deslogando.");
                        await signOut(auth);
                    }
                } catch (error) {
                    console.error("Erro durante a verificação de autenticação:", error);
                    await signOut(auth);
                }
            } else {
                redirectTo('index.html');
            }
        });

        async function startAdminApp(user, data) {
            userData = { id: user.uid, ...data };
            
            initializeTemplates();
            await Promise.all([
                loadPatrols(),
                loadCheckpoints(),
                loadUsers()
            ]);
            
            setupUI();
            handleNavigation(null, 'adminDashboard', 'Painel');
        }
        
        function setupUI() {
            const isDesktop = window.innerWidth >= 1024;
            document.getElementById('admin-desktop-layout').classList.toggle('hidden', !isDesktop);
            document.getElementById('admin-mobile-layout').classList.toggle('hidden', isDesktop);
            
            if (!uiInitialized) {
                updateNavigation();
                
                document.getElementById('admin-desktop-nav').addEventListener('click', handleNavigation);
                document.getElementById('admin-mobile-nav').addEventListener('click', handleNavigation);
                document.getElementById('bottom-nav').addEventListener('click', handleNavigation);
                document.getElementById('logout-button-desktop').addEventListener('click', () => signOut(auth));
                document.getElementById('logout-button-mobile').addEventListener('click', () => signOut(auth));
                document.getElementById('modal-close-button').addEventListener('click', closeModal);
                document.getElementById('modal-body').addEventListener('click', handleModalAction);
                document.getElementById('desktop-user-info').addEventListener('click', () => openModal('Meu Perfil', null, { renderer: (c) => loadProfile(c) }));
                document.getElementById('mobile-user-info').addEventListener('click', () => {
                    closeSideMenu();
                    openModal('Meu Perfil', null, { renderer: (c) => loadProfile(c) });
                });
                document.getElementById('menu-button-mobile').addEventListener('click', openSideMenu);
                menuOverlay.addEventListener('click', closeSideMenu);
                
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('[data-action="open-menu"]') && !e.target.closest('[id^=menu-]')) {
                        document.querySelectorAll('[id^=menu-]').forEach(menu => menu.classList.add('hidden'));
                    }
                });
                modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) closeModal(); });
                window.addEventListener('resize', setupUI);
                uiInitialized = true;
            }
            updateUserInfo();
        }
        
        function updateUserInfo() {
             const userInfoHtml = `
                <div class="text-right overflow-hidden">
                    <p class="font-semibold truncate">${userData.name}</p>
                    <p class="text-sm text-gray-500 truncate">${userData.email}</p>
                </div>
                <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center font-bold text-[var(--primary-blue)] text-xl flex-shrink-0">
                    ${(userData.name || 'U').charAt(0)}
                </div>`;
            document.getElementById('desktop-user-info').innerHTML = `<div class="flex items-center gap-3">${userInfoHtml}</div>`;
            document.getElementById('mobile-user-info').innerHTML =  `<div class="flex items-center gap-3 p-2 border-b border-gray-200">${userInfoHtml}</div>`;
        }

        function openSideMenu() {
            sideMenuMobile.classList.remove('-translate-x-full');
            menuOverlay.classList.remove('hidden');
        }

        function closeSideMenu() {
            sideMenuMobile.classList.add('-translate-x-full');
            menuOverlay.classList.add('hidden');
        }

        function initializeTemplates() {
            const templateContainer = document.getElementById('screen-templates');
            templateContainer.innerHTML = `
                <div id="admin-dashboard-screen"></div>
                <div id="admin-patrols-screen"></div>
                <div id="admin-checkpoints-screen"></div>
                <div id="admin-reports-screen"></div>
                <div id="admin-alerts-screen"></div>
                <div id="profile-screen"></div>
            `;
            screens = {
                adminDashboard: document.getElementById('admin-dashboard-screen'),
                adminPatrols: document.getElementById('admin-patrols-screen'),
                adminCheckpoints: document.getElementById('admin-checkpoints-screen'),
                adminReports: document.getElementById('admin-reports-screen'),
                adminAlerts: document.getElementById('admin-alerts-screen'),
                profile: document.getElementById('profile-screen'),
            };
        }

        function navigateToScreen(screenName, title) {
            const isDesktop = window.innerWidth >= 1024;
            const mainContent = isDesktop ? mainContentDesktop : mainContentMobile;
            const templateContainer = document.getElementById('screen-templates');

            if (mainContent.firstChild) {
                templateContainer.appendChild(mainContent.firstChild);
            }

            if (screens[screenName]) {
                mainContent.appendChild(screens[screenName]);
                headerTitleDesktop.textContent = title;
                headerTitleMobile.textContent = title;
            }
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            toast.className = `fixed bottom-24 left-1/2 -translate-x-1/2 text-white px-6 py-3 rounded-full shadow-lg z-50 ${isError ? 'bg-red-600' : 'bg-gray-900'}`;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        function openModal(title, contentHtml, state = {}) {
            state.title = title;
            state.contentHtml = contentHtml;
            modalStack.push(state);
            renderCurrentModal();
        }

        function renderCurrentModal() {
            if (modalStack.length === 0) {
                modalOverlay.classList.add('hidden');
                if (mapInstance) {
                    mapInstance.remove();
                    mapInstance = null;
                }
                return;
            }
            const currentState = modalStack[modalStack.length - 1];
            document.getElementById('modal-title').textContent = currentState.title;
            const modalBody = document.getElementById('modal-body');

            if (currentState.renderer) {
                currentState.renderer(modalBody);
            } else {
                modalBody.innerHTML = currentState.contentHtml;
            }

            modalOverlay.classList.remove('hidden');
        }

        function closeModal() {
            if (modalStack.length > 0) {
                modalStack.pop();
                renderCurrentModal();
            }
        }

        function loadAdminDashboard() {
            const container = screens.adminDashboard;
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-xl shadow-md border border-[var(--border-color)]">
                        <p class="text-sm font-semibold text-[var(--text-secondary)]">Vigilantes</p>
                        <p id="admin-total-users" class="text-3xl font-extrabold text-[var(--primary-blue)]">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-md border border-[var(--border-color)]">
                        <p class="text-sm font-semibold text-[var(--text-secondary)]">Rondas Finalizadas Hoje</p>
                        <p id="admin-rounds-today" class="text-3xl font-extrabold text-[var(--primary-blue)]">0</p>
                    </div>
                </div>
                <h3 class="font-bold mb-2 text-[var(--text-secondary)] text-lg">Gerenciar Vigilantes</h3>
                <div class="relative mb-4">
                    <input id="search-user-input" type="text" placeholder="Buscar por nome ou email..." class="w-full pl-10 pr-4 py-3 rounded-lg bg-white text-[var(--text-primary)] border-2 border-transparent focus:border-[var(--accent-blue)] focus:ring-0 transition-all shadow-sm">
                    <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
                <div id="users-list" class="space-y-3"></div>`;
            container.querySelector('#search-user-input').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredUsers = allUsers.filter(user => user.email.toLowerCase().includes(searchTerm) || (user.name && user.name.toLowerCase().includes(searchTerm)));
                renderUsersList(filteredUsers);
            });
            loadAdminStats();
            renderUsersList(allUsers);
        }

        async function loadAdminStats() {
            const totalUsersEl = document.getElementById('admin-total-users');
            const roundsTodayEl = document.getElementById('admin-rounds-today');
            if(totalUsersEl) totalUsersEl.textContent = allUsers.filter(u => u.role === 'guard').length;

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const promises = allUsers.map(userDoc => userDoc.role === 'guard' ? getDocs(query(collection(db, `artifacts/${appId}/users/${userDoc.id}/completedPatrols`), where("endTime", ">=", today))).then(s => s.size) : 0);
            const totalRoundsToday = (await Promise.all(promises)).reduce((sum, count) => sum + count, 0);
            if(roundsTodayEl) roundsTodayEl.textContent = totalRoundsToday;
        }

        async function loadUsers() {
            const q = query(collection(db, `users`));
            const querySnapshot = await getDocs(q);
            allUsers = querySnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        }

        function renderUsersList(users) {
            const usersListDiv = document.getElementById('users-list');
            if (!usersListDiv) return;
            usersListDiv.innerHTML = users.length === 0 ? '<p class="text-gray-500 text-center mt-8">Nenhum usuário encontrado.</p>' : users.map(user => `
                <div class="bg-white p-4 rounded-xl flex justify-between items-center border border-[var(--border-color)] relative">
                    <div class="flex items-center gap-4 overflow-hidden">
                        <div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center font-bold text-[var(--primary-blue)] text-xl flex-shrink-0">
                            ${(user.name || 'U').charAt(0)}
                        </div>
                        <div class="overflow-hidden">
                            <p class="font-semibold text-[var(--text-primary)] truncate">${user.name || 'Nome não definido'}</p>
                            <p class="text-sm text-[var(--text-secondary)] truncate">${user.email}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                        <span class="text-xs font-bold uppercase px-2 py-1 rounded-full ${user.role === 'admin' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">${user.role}</span>
                        <button class="p-2 text-gray-500 hover:text-[var(--primary-blue)]" data-action="open-menu" data-userid="${user.id}">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path></svg>
                        </button>
                    </div>
                    <div id="menu-${user.id}" class="hidden absolute right-4 top-14 bg-white shadow-lg rounded-lg border border-gray-200 z-10 w-48">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-action="view-rounds" data-userid="${user.id}" data-username="${user.name}">Ver Rondas</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-action="edit-role" data-userid="${user.id}" data-username="${user.name}" data-currentrole="${user.role}">Editar Função</a>
                        <a href="#" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50" data-action="delete-user" data-userid="${user.id}" data-username="${user.name}">Excluir Usuário</a>
                    </div>
                </div>`).join('');
            usersListDiv.querySelectorAll('[data-action]').forEach(el => el.addEventListener('click', handleUserAction));
        }

        function handleUserAction(e) {
            e.stopPropagation();
            const target = e.target.closest('[data-action]');
            if (!target) return;
            const action = target.dataset.action;
            const userId = target.dataset.userid;
            const userName = target.dataset.username;
            document.querySelectorAll('[id^=menu-]').forEach(menu => { if (menu.id !== `menu-${userId}`) menu.classList.add('hidden'); });
            if (action === 'open-menu') document.getElementById(`menu-${userId}`).classList.toggle('hidden');
            if (action === 'view-rounds') openModal(`Rondas de ${userName}`, null, { renderer: (c) => showPatrolsForUser(userId, c) });
            if (action === 'edit-role') {
                const newRole = target.dataset.currentrole === 'admin' ? 'guard' : 'admin';
                openModal('Editar Função', `<p>Mudar a função de <strong>${userName}</strong> para <strong>${newRole.toUpperCase()}</strong>?</p>
                    <div class="mt-6 flex justify-end gap-3"><button data-action="close-modal" class="px-4 py-2 rounded-lg bg-gray-200">Cancelar</button><button id="confirm-edit-btn" data-userid="${userId}" data-newrole="${newRole}" class="px-4 py-2 rounded-lg bg-blue-600 text-white">Confirmar</button></div>`);
            }
            if (action === 'delete-user') {
                 openModal('Excluir Usuário', `<p>Tem certeza que deseja excluir <strong>${userName}</strong>?</p>
                    <div class="mt-6 flex justify-end gap-3"><button data-action="close-modal" class="px-4 py-2 rounded-lg bg-gray-200">Cancelar</button><button id="confirm-delete-btn" data-userid="${userId}" class="px-4 py-2 rounded-lg bg-red-600 text-white">Excluir</button></div>`);
            }
        }
        
        function handleModalAction(e) {
            const target = e.target;
            const action = target.closest('[data-action]')?.dataset.action;

            if (action === 'close-modal' || target.id === 'modal-close-button') closeModal();
            if (target.id === 'confirm-edit-btn') {
                updateDoc(doc(db, "users", target.dataset.userid), { role: target.dataset.newrole }).then(() => {
                    showToast("Função atualizada!");
                    loadUsers().then(() => renderUsersList(allUsers));
                    closeModal();
                }).catch(() => showToast("Erro.", true));
            }
            if (target.id === 'confirm-delete-btn') {
                deleteDoc(doc(db, "users", target.dataset.userid)).then(() => {
                    showToast("Usuário excluído!");
                    loadUsers().then(() => renderUsersList(allUsers));
                    closeModal();
                }).catch(() => showToast("Erro.", true));
            }
            if (target.id === 'save-patrol-btn') {
                const patrolName = document.getElementById('patrol-name-input').value.trim();
                if (!patrolName) return showToast("O nome do roteiro é obrigatório.", true);

                const selectedCheckpoints = Array.from(document.querySelectorAll('#checkpoints-list-modal input:checked')).map(cb => ({ name: cb.dataset.name, qrContent: cb.dataset.qr }));
                if (selectedCheckpoints.length === 0) return showToast("Selecione pelo menos um ponto.", true);
                
                target.disabled = true;
                target.textContent = 'Salvando...';

                addDoc(collection(db, `artifacts/${appId}/public/data/patrols`), { name: patrolName, checkpoints: selectedCheckpoints }).then(() => {
                    showToast("Roteiro salvo!");
                    loadPatrols().then(renderPatrols);
                    closeModal();
                }).catch(() => showToast("Erro ao salvar.", true)).finally(() => {
                    target.disabled = false;
                    target.textContent = 'Salvar Roteiro';
                });
            }
            if (target.id === 'save-checkpoint-btn') {
                const name = document.getElementById('checkpoint-name-input').value;
                const qrContent = document.getElementById('checkpoint-qr-input').value;
                if (!name || !qrContent) return showToast("Preencha todos os campos.", true);
                
                addDoc(collection(db, `artifacts/${appId}/public/data/checkpoints`), { name, qrContent }).then(() => {
                    showToast("Ponto salvo!");
                    loadCheckpoints().then(renderCheckpoints);
                    closeModal();
                    setTimeout(() => displayGeneratedQRCode(name, qrContent), 350);
                }).catch(() => showToast("Erro.", true));
            }
        }
        
        async function showPatrolsForUser(userId, container) {
            container.innerHTML = '<div class="flex justify-center items-center p-8"><span class="loader"></span></div>';
            try {
                const q = query(collection(db, `artifacts/${appId}/users/${userId}/completedPatrols`), orderBy("endTime", "desc"));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    container.innerHTML = '<p class="text-center text-gray-500">Nenhuma ronda encontrada.</p>';
                    return;
                }
                
                const patrolsByDate = {};
                const patrolDocs = querySnapshot.docs.map(d => ({id: d.id, ...d.data()}));

                patrolDocs.forEach(patrol => {
                    const date = patrol.endTime.toDate().toLocaleDateString('pt-BR', { year: 'numeric', month: 'long', day: 'numeric' });
                    if (!patrolsByDate[date]) patrolsByDate[date] = [];
                    patrolsByDate[date].push(patrol);
                });

                let datesHtml = '<div class="space-y-2">';
                for (const date in patrolsByDate) {
                    datesHtml += `<div class="bg-white p-4 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors border border-[var(--border-color)]" data-date-key="${date}">
                           <p class="font-semibold text-[var(--text-primary)] flex justify-between items-center">${date} <span class="text-sm font-normal text-white bg-[var(--primary-blue)] px-2 py-0.5 rounded-full">${patrolsByDate[date].length}</span></p>
                        </div>`;
                }
                datesHtml += '</div>';
                container.innerHTML = datesHtml;
                container.querySelectorAll('[data-date-key]').forEach(el => {
                    el.addEventListener('click', () => {
                        const dateKey = el.dataset.dateKey;
                        openModal(`Rondas de ${dateKey}`, null, { renderer: (c) => showPatrolsForDate(c, dateKey, patrolsByDate[dateKey]) });
                    });
                });
            } catch (error) {
                container.innerHTML = `<p class="text-center text-red-500">Erro ao carregar rondas.</p>`;
            }
        }

        function showPatrolsForDate(container, date, patrols) {
            let patrolsHtml = '<div class="space-y-2">';
            patrols.forEach((patrol, index) => {
                const startTime = patrol.startTime.toDate().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                const endTime = patrol.endTime.toDate().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                const eventCounts = patrol.events.reduce((acc, event) => { acc[event.type] = (acc[event.type] || 0) + 1; return acc; }, { qrScan: 0, photo: 0 });

                patrolsHtml += `<button class="w-full bg-white p-3 rounded-lg flex justify-between items-center border border-[var(--border-color)] text-left hover:bg-gray-50" data-patrol-index="${index}">
                        <div class="overflow-hidden">
                            <p class="font-bold text-[var(--text-primary)] truncate">${patrol.patrolName}</p>
                            <p class="text-sm text-[var(--text-secondary)]">Início: ${startTime} | Fim: ${endTime}</p>
                             <p class="text-sm text-[var(--text-secondary)]">Registros: ${eventCounts.qrScan} QR / ${eventCounts.photo} Fotos</p>
                        </div>
                        <svg class="w-5 h-5 text-gray-400 flex-shrink-0 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>`;
            });
            patrolsHtml += '</div>';
            container.innerHTML = patrolsHtml;
            container.querySelectorAll('[data-patrol-index]').forEach(el => {
                el.addEventListener('click', () => {
                    const patrolData = patrols[parseInt(el.dataset.patrolIndex)];
                    openModal(`Detalhes: ${patrolData.patrolName}`, null, { renderer: (c) => showPatrolDetails(c, patrolData, date) });
                });
            });
        }
        
        function showPatrolDetails(container, patrol, date) {
            const qrScans = patrol.events.filter(e => e.type === 'qrScan').sort((a,b) => a.timestamp.seconds - b.timestamp.seconds);
            const photos = patrol.events.filter(e => e.type === 'photo');
            const locations = patrol.events.filter(e => e.latitude && e.longitude).map(e => [e.latitude, e.longitude, 0.8]);

            let detailsHtml = '<div class="space-y-6">';
            detailsHtml += '<div><h4 class="font-bold mb-2 text-base text-[var(--text-secondary)]">Mapa de Calor da Ronda</h4><div id="heatmap-container" class="bg-gray-200 h-64 w-full rounded-lg"></div></div>';
            if (qrScans.length > 0) {
                detailsHtml += '<div><h4 class="font-bold mb-2 text-base text-[var(--text-secondary)]">Pontos Registrados</h4><div class="space-y-2">';
                qrScans.forEach(scan => {
                    const time = scan.timestamp.toDate().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    detailsHtml += `<div class="bg-white p-3 rounded-lg border border-[var(--border-color)]">
                            <div class="flex justify-between items-center">
                                <p class="font-semibold text-sm">${scan.checkpointName} <span class="text-xs text-gray-500">(${scan.qrData})</span></p>
                                <span class="font-bold text-sm text-[var(--primary-blue)]">${time}</span>
                            </div>
                            <div class="text-xs text-gray-600 mt-1">
                                Local: <a href="https://www.google.com/maps/search/?api=1&query=${scan.latitude},${scan.longitude}" target="_blank" class="text-blue-600 hover:underline">${scan.latitude.toFixed(4)}, ${scan.longitude.toFixed(4)}</a>
                            </div>
                        </div>`;
                });
                detailsHtml += '</div></div>';
            }
            if (photos.length > 0) {
                detailsHtml += `<div>
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-bold text-base text-[var(--text-secondary)]">Fotos</h4>
                            <button id="download-zip-btn" class="bg-green-600 text-white text-xs font-bold px-3 py-1 rounded-lg hover:bg-green-700">Baixar (.zip)</button>
                        </div>
                        <div id="photo-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                            ${photos.map((p, index) => `<img src="${p.photoBase64}" class="w-full h-32 object-cover rounded-lg shadow-md cursor-pointer" data-photo-index="${index}">`).join('')}
                        </div>
                    </div>`;
            }
            container.innerHTML = detailsHtml + '</div>';

            container.querySelectorAll('[data-photo-index]').forEach(el => {
                el.addEventListener('click', () => openModal('Foto da Ronda', `<img src="${photos[parseInt(el.dataset.photoIndex)].photoBase64}" class="w-full h-auto rounded-lg">`));
            });

            if (photos.length > 0) {
                container.querySelector('#download-zip-btn').addEventListener('click', async () => {
                    showToast('Preparando arquivo .zip...');
                    const zip = new JSZip();
                    const photoPromises = photos.map((photo, index) => fetch(photo.photoBase64).then(res => res.blob()).then(blob => {
                        const time = photo.timestamp.toDate().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' }).replace(/:/g, '-');
                        zip.file(`foto-${index + 1}-${time}.jpg`, blob);
                    }));
                    await Promise.all(photoPromises);
                    zip.generateAsync({type:"blob"}).then(content => {
                        const link = document.createElement('a');
                        const safeDate = date.replace(/[^a-z0-9]/gi, '-');
                        link.href = URL.createObjectURL(content);
                        link.download = `Ronda-${patrol.patrolName.replace(/[^a-z0-9]/gi, '-')}-${safeDate}.zip`;
                        link.click();
                        showToast('Download iniciado!');
                    });
                });
            }

            if (locations.length > 0) {
                setTimeout(() => {
                    try {
                        const mapContainer = document.getElementById('heatmap-container');
                        if (mapContainer && !mapContainer._leaflet_id) {
                           mapInstance = L.map('heatmap-container').setView(locations[0], 15);
                           L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapInstance);
                           L.heatLayer(locations, {radius: 25, blur: 15, maxZoom: 17}).addTo(mapInstance);
                        }
                    } catch(e) { /* silent fail */ }
                }, 100);
            } else {
                 if(document.getElementById('heatmap-container')) document.getElementById('heatmap-container').innerHTML = '<p class="text-gray-500 p-4 text-center">Nenhum dado de localização para exibir.</p>';
            }
        }
        
        async function loadPatrols() {
            const q = query(collection(db, `artifacts/${appId}/public/data/patrols`));
            const querySnapshot = await getDocs(q);
            patrols = querySnapshot.docs.map(d => ({id: d.id, ...d.data()}));
        }

        function renderPatrols() {
            const screen = screens.adminPatrols;
            screen.innerHTML = `<div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-[var(--text-secondary)] text-lg">Roteiros de Ronda</h3>
                    <button id="add-patrol-btn" class="bg-[var(--primary-blue)] text-white font-bold px-4 py-2 rounded-lg hover:bg-[var(--accent-blue)] text-sm">Novo Roteiro</button>
                </div>
                <div id="patrols-list" class="space-y-3"></div>`;
            const listDiv = screen.querySelector('#patrols-list');
            listDiv.innerHTML = patrols.length === 0 ? '<p class="text-center text-gray-500 p-4">Nenhum roteiro criado.</p>' : patrols.map(p => `
                <div class="bg-white p-4 rounded-xl border border-[var(--border-color)]">
                    <div class="flex justify-between items-start">
                         <div>
                            <p class="font-semibold text-[var(--text-primary)]">${p.name}</p>
                            <p class="text-sm text-[var(--text-secondary)]">${p.checkpoints.length} ponto(s)</p>
                        </div>
                        <button data-action="delete-patrol" data-id="${p.id}" class="p-2 text-red-500 hover:bg-red-100 rounded-full flex-shrink-0">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                    <div class="mt-3 pt-3 border-t text-sm space-y-1">
                        ${p.checkpoints.map(c => `<div class="flex items-center gap-2"><svg class="h-4 w-4 text-purple-600 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V6a2 2 0 0 1 2-2h2M4 16v2a2 2 0 0 0 2 2h2m8-12h2a2 2 0 0 1 2 2v2m-4 8h2a2 2 0 0 0 2-2v-2M7 12h10" /></svg><span class="font-medium">${c.name}</span> <span class="text-gray-500">(${c.qrContent})</span></div>`).join('')}
                    </div>
                </div>`).join('');
            
            screen.querySelector('#add-patrol-btn').addEventListener('click', () => {
                let checkpointOptions = checkpoints.length > 0 ? checkpoints.map(c => `
                    <label class="flex items-center gap-3 bg-white p-3 rounded-lg hover:bg-gray-50 border cursor-pointer">
                        <input type="checkbox" data-name="${c.name}" data-qr="${c.qrContent}" class="h-5 w-5 rounded text-[var(--accent-blue)] focus:ring-[var(--accent-blue)]">
                        <div>
                            <p class="font-medium text-sm">${c.name}</p>
                            <p class="text-xs text-gray-500">QR: ${c.qrContent}</p>
                        </div>
                    </label>`).join('') : '<p class="text-center text-sm text-gray-500 p-4 bg-gray-100 rounded-lg">Crie um Ponto na tela "Pontos (QR Codes)" primeiro.</p>';

                openModal('Novo Roteiro de Ronda', `
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium text-[var(--text-secondary)]">Nome do Roteiro</label>
                            <input id="patrol-name-input" type="text" class="w-full mt-1 px-4 py-3 rounded-lg bg-white shadow-sm">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-[var(--text-secondary)]">Selecione os Pontos</label>
                            <div id="checkpoints-list-modal" class="mt-2 space-y-2 max-h-48 overflow-y-auto p-1">${checkpointOptions}</div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end gap-3">
                        <button data-action="close-modal" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">Cancelar</button>
                        <button id="save-patrol-btn" class="px-4 py-2 rounded-lg bg-[var(--primary-blue)] text-white hover:bg-[var(--accent-blue)]">Salvar Roteiro</button>
                    </div>`);
            });
            screen.querySelector('#patrols-list').addEventListener('click', (e) => {
                const target = e.target.closest('[data-action="delete-patrol"]');
                if (target && confirm("Tem certeza que deseja excluir este roteiro?")) {
                    deleteDoc(doc(db, `artifacts/${appId}/public/data/patrols`, target.dataset.id))
                        .then(() => {
                            showToast("Roteiro excluído!");
                            loadPatrols().then(renderPatrols);
                        }).catch(() => showToast("Erro ao excluir.", true));
                }
            });
        }
        
        async function loadCheckpoints() {
            const q = query(collection(db, `artifacts/${appId}/public/data/checkpoints`));
            const querySnapshot = await getDocs(q);
            checkpoints = querySnapshot.docs.map(d => ({id: d.id, ...d.data()}));
        }

        function renderCheckpoints() {
            const screen = screens.adminCheckpoints;
            screen.innerHTML = `<div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-[var(--text-secondary)] text-lg">Pontos (QR Codes)</h3>
                    <button id="add-checkpoint-btn" class="bg-[var(--primary-blue)] text-white font-bold px-4 py-2 rounded-lg hover:bg-[var(--accent-blue)] text-sm">Novo Ponto</button>
                </div>
                <div id="checkpoints-list" class="space-y-3"></div>`;
            const listDiv = screen.querySelector('#checkpoints-list');
            listDiv.innerHTML = checkpoints.length === 0 ? '<p class="text-center text-gray-500 p-4">Nenhum ponto criado.</p>' : checkpoints.map(c => `
                <div class="bg-white p-4 rounded-xl flex justify-between items-center border">
                    <div>
                        <p class="font-semibold">${c.name}</p>
                        <p class="text-sm text-gray-500">QR: ${c.qrContent}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button data-action="view-qr" data-name="${c.name}" data-qr="${c.qrContent}" class="p-2 text-gray-500 hover:bg-gray-100 rounded-full">
                            <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M4 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm3 1a1 1 0 00-1 1v10a1 1 0 102 0V5a1 1 0 00-1-1zm3 0a1 1 0 00-1 1v10a1 1 0 102 0V5a1 1 0 00-1-1zm3 0a1 1 0 00-1 1v10a1 1 0 102 0V5a1 1 0 00-1-1zm3 1a1 1 0 00-1-1v12a1 1 0 102 0V5a1 1 0 00-1-1z" /></svg>
                        </button>
                         <button data-action="delete-checkpoint" data-id="${c.id}" class="p-2 text-red-500 hover:bg-red-100 rounded-full">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                </div>`).join('');
            
            screen.querySelector('#add-checkpoint-btn').addEventListener('click', () => {
                openModal('Novo Ponto de Verificação', `<div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium text-gray-600">Nome do Ponto</label>
                            <input id="checkpoint-name-input" type="text" class="w-full mt-1 px-4 py-3 rounded-lg bg-white shadow-sm">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600">Texto do QR Code</label>
                            <input id="checkpoint-qr-input" type="text" class="w-full mt-1 px-4 py-3 rounded-lg bg-white shadow-sm">
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end gap-3">
                        <button data-action="close-modal" class="px-4 py-2 rounded-lg bg-gray-200">Cancelar</button>
                        <button id="save-checkpoint-btn" class="px-4 py-2 rounded-lg bg-blue-600 text-white">Salvar e Gerar QR</button>
                    </div>`);
            });
            screen.querySelector('#checkpoints-list').addEventListener('click', handleCheckpointAction);
        }

        async function handleCheckpointAction(e) {
            const target = e.target.closest('[data-action]');
            if (!target) return;
            const { action, id, name, qr } = target.dataset;
            if (action === 'delete-checkpoint' && confirm("Tem certeza?")) {
                deleteDoc(doc(db, `artifacts/${appId}/public/data/checkpoints`, id))
                    .then(() => {
                        showToast("Ponto excluído.");
                        loadCheckpoints().then(renderCheckpoints);
                    }).catch(() => showToast("Erro ao excluir.", true));
            }
            if (action === 'view-qr') {
                displayGeneratedQRCode(name, qr);
            }
        }
        
        function displayGeneratedQRCode(name, qrContent) {
            openModal(`QR Code para: ${name}`, `<div class="flex flex-col items-center text-center">
                    <div id="qr-code-container" class="p-4 bg-white rounded-lg w-full max-w-xs"></div>
                    <div class="mt-6 flex gap-3 w-full">
                        <button data-action="close-modal" class="w-1/2 px-4 py-2 rounded-lg bg-gray-200">Fechar</button>
                        <button id="download-qr-btn" class="w-1/2 bg-green-600 text-white font-bold py-3 rounded-lg">Baixar</button>
                    </div></div>`);
            const qr = qrcode(4, 'L');
            qr.addData(qrContent);
            qr.make();
            document.getElementById('qr-code-container').innerHTML = qr.createImgTag(6, 12);
            document.getElementById('download-qr-btn').addEventListener('click', () => {
                const canvas = document.createElement('canvas');
                canvas.width = 512; canvas.height = 512;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = 'white'; ctx.fillRect(0, 0, 512, 512);
                const qrCanvas = document.getElementById('qr-code-container').querySelector('canvas');
                ctx.drawImage(qrCanvas, 51.2, 51.2, 409.6, 409.6);
                const link = document.createElement('a');
                link.download = `QRCode-${name.replace(/\s+/g, '-')}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }

        function updateNavigation() {
            const navItems = `
                <a href="#" data-nav="adminDashboard" class="nav-item flex items-center gap-4 p-3 rounded-lg hover:bg-gray-100 text-[var(--text-secondary)] font-semibold">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <span>Painel</span>
                </a>
                <a href="#" data-nav="adminPatrols" class="nav-item flex items-center gap-4 p-3 rounded-lg hover:bg-gray-100 text-[var(--text-secondary)] font-semibold">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13V7m0 13l6-3l5.447 2.724A1 1 0 0021 16.382V5.618a1 1 0 00-1.447-.894L15 7m-6 6l6-3"></path></svg>
                    <span>Roteiros</span>
                </a>
                <a href="#" data-nav="adminCheckpoints" class="nav-item flex items-center gap-4 p-3 rounded-lg hover:bg-gray-100 text-[var(--text-secondary)] font-semibold">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V6a2 2 0 0 1 2-2h2M4 16v2a2 2 0 0 0 2 2h2m8-12h2a2 2 0 0 1 2 2v2m-4 8h2a2 2 0 0 0 2-2v-2M7 12h10"></path></svg>
                    <span>Pontos (QR Codes)</span>
                </a>
                <a href="#" data-nav="adminReports" class="nav-item flex items-center gap-4 p-3 rounded-lg hover:bg-gray-100 text-[var(--text-secondary)] font-semibold">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    <span>Relatórios</span>
                </a>
                <a href="#" data-nav="adminAlerts" class="nav-item flex items-center gap-4 p-3 rounded-lg hover:bg-gray-100 text-[var(--text-secondary)] font-semibold">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.636 5.636a9 9 0 0112.728 0m-12.728 0l12.728 12.728"></path></svg>
                    <span>Alertas</span>
                </a>
            `;
            document.getElementById('admin-desktop-nav').innerHTML = navItems;
            document.getElementById('admin-mobile-nav').innerHTML = navItems;

            const bottomNavEl = document.getElementById('bottom-nav');
            const bottomNavItems = `
                <button data-nav="adminDashboard" class="bottom-nav-item nav-item p-2 flex flex-col items-center justify-center">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <span class="text-xs mt-1 block">Painel</span>
                </button>
                <button data-nav="adminPatrols" class="bottom-nav-item nav-item p-2 flex flex-col items-center justify-center">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13V7m0 13l6-3l5.447 2.724A1 1 0 0021 16.382V5.618a1 1 0 00-1.447-.894L15 7m-6 6l6-3"></path></svg>
                    <span class="text-xs mt-1 block">Roteiros</span>
                </button>
                <button data-nav="adminCheckpoints" class="bottom-nav-item nav-item p-2 flex flex-col items-center justify-center">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V6a2 2 0 0 1 2-2h2M4 16v2a2 2 0 0 0 2 2h2m8-12h2a2 2 0 0 1 2 2v2m-4 8h2a2 2 0 0 0 2-2v-2M7 12h10"></path></svg>
                    <span class="text-xs mt-1 block">Pontos</span>
                </button>
                <button data-nav="adminReports" class="bottom-nav-item nav-item p-2 flex flex-col items-center justify-center">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    <span class="text-xs mt-1 block">Relatórios</span>
                </button>
                <button data-nav="adminAlerts" class="bottom-nav-item nav-item p-2 flex flex-col items-center justify-center">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.636 5.636a9 9 0 0112.728 0m-12.728 0l12.728 12.728"></path></svg>
                    <span class="text-xs mt-1 block">Alertas</span>
                </button>
            `;
            bottomNavEl.innerHTML = bottomNavItems;
            bottomNavEl.classList.remove('hidden');
            bottomNavEl.classList.add('grid');
        }

        function handleNavigation(e, navTarget, navTitle) {
            if(e) e.preventDefault();
            
            const targetEl = e ? e.target.closest('[data-nav]') : null;
            if (!targetEl && !navTarget) return;

            const screenName = navTarget || targetEl.dataset.nav;
            const title = navTitle || targetEl.querySelector('span').textContent;

            if (!screenName) return;

            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll(`[data-nav=${screenName}]`).forEach(item => item.classList.add('active'));
            
            const screenMap = {
                profile: { load: loadProfile },
                adminDashboard: { load: loadAdminDashboard },
                adminPatrols: { load: renderPatrols },
                adminCheckpoints: { load: renderCheckpoints },
                adminReports: { load: loadReports },
                adminAlerts: { load: loadAlertsScreen },
            };
            
            navigateToScreen(screenName, title);
            if (screenMap[screenName]?.load) {
                screenMap[screenName].load();
            }

            if (e && e.currentTarget.id === 'admin-mobile-nav') {
                closeSideMenu();
            }
        }

        function loadProfile(container) {
            const targetContainer = container || (window.innerWidth >= 1024 ? mainContentDesktop : screens.profile);
            targetContainer.innerHTML = `
                <div class="space-y-6 max-w-md mx-auto">
                    <div>
                        <label class="text-sm font-medium text-[var(--text-secondary)]">Nome Completo</label>
                        <input id="profile-name-input" type="text" value="${userData.name || ''}" class="w-full mt-1 px-4 py-3 rounded-lg bg-white shadow-sm">
                    </div>
                     <div>
                        <label class="text-sm font-medium text-[var(--text-secondary)]">Email</label>
                        <p class="w-full mt-1 px-4 py-3 text-gray-600 bg-gray-100 rounded-lg">${userData.email}</p>
                    </div>
                </div>
                <button id="save-profile-button" class="w-full mt-8 bg-[var(--primary-blue)] text-white font-bold py-3 rounded-lg max-w-md mx-auto block">Salvar Alterações</button>`;
            
            targetContainer.querySelector('#save-profile-button').addEventListener('click', async () => {
                const newName = targetContainer.querySelector('#profile-name-input').value;
                if (newName && newName !== userData.name) {
                    await updateDoc(doc(db, "users", userData.id), { name: newName });
                    userData.name = newName;
                    showToast("Perfil atualizado!");
                    updateUserInfo();
                }
            });
        }

        async function loadReports() {
            const container = screens.adminReports;
            container.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md border">
                    <h3 class="font-bold text-lg mb-4">Resumo Geral</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center py-2 border-b"><span>Total de Vigilantes:</span><span class="font-bold text-lg">${allUsers.filter(u=>u.role === 'guard').length}</span></div>
                        <div class="flex justify-between items-center py-2 border-b"><span>Total de Roteiros:</span><span class="font-bold text-lg">${patrols.length}</span></div>
                        <div class="flex justify-between items-center py-2 border-b"><span>Total de Pontos (QR):</span><span class="font-bold text-lg">${checkpoints.length}</span></div>
                        <div class="flex justify-between items-center py-2"><span>Rondas Hoje:</span><span id="report-rounds-today" class="font-bold text-lg"></span></div>
                    </div>
                </div>`;
            const roundsTodayEl = document.getElementById('report-rounds-today');
            await loadAdminStats();
            const roundsTodayContainer = document.getElementById('admin-rounds-today');
            if (roundsTodayContainer) {
                 roundsTodayEl.textContent = roundsTodayContainer.textContent;
            }
        }

        async function loadAlertsScreen() {
            const container = screens.adminAlerts;
            container.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md border">
                    <h3 class="font-bold text-lg mb-1">Enviar Novo Alerta</h3>
                    <p class="text-gray-500 mb-4 text-sm">A mensagem será enviada para todos os vigilantes.</p>
                    <textarea id="alert-message-input" class="w-full p-3 rounded-lg bg-gray-100 border-2" rows="4"></textarea>
                    <button id="send-alert-btn" class="w-full mt-4 bg-[var(--primary-blue)] text-white font-bold py-3 rounded-lg">Enviar Alerta</button>
                </div>`;
            container.querySelector('#send-alert-btn').addEventListener('click', async () => {
                const message = document.getElementById('alert-message-input').value.trim();
                if (!message) return showToast("A mensagem não pode estar vazia.", true);
                await setDoc(doc(db, `artifacts/${appId}/public/data/alerts`, "latest"), { message, timestamp: new Date() });
                showToast("Alerta enviado!");
                document.getElementById('alert-message-input').value = '';
            });
        }
    </script>
</body>
</html