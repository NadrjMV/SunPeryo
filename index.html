<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SunPeryo - Confirmação de Ronda</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Bibliotecas de Terceiros -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <style>
        /* Estilização base e customizações */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: contain;
            background-color: #f3f4f6; /* Gray-100 */
        }

        /* Animação para o menu lateral */
        #side-menu { transition: transform 0.3s ease-in-out; }
        #side-menu.closed { transform: translateX(-100%); }
        #side-menu.open { transform: translateX(0); }
        #menu-overlay { transition: opacity 0.3s ease-in-out; }
        
        #qr-reader { border: none; }
        #heatmap-container { height: 350px; width: 100%; }

        .loader {
            width: 48px; height: 48px;
            border: 5px solid #d1d5db; /* Gray-300 */
            border-bottom-color: #2563eb; /* Blue-600 */
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Estilo para a barra de navegação inferior */
        .bottom-nav-item.active svg { color: #2563eb; } /* Blue-600 */
        .bottom-nav-item.active span { color: #2563eb; font-weight: 600; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Container da Aplicação Inteira -->
    <div id="app-shell" class="max-w-lg mx-auto bg-gray-50 min-h-screen shadow-2xl relative overflow-hidden">

        <!-- TELA DE CARREGAMENTO INICIAL -->
        <div id="loading-screen" class="h-screen flex flex-col justify-center items-center bg-white text-gray-700">
            <span class="loader"></span>
            <p class="mt-4 text-lg font-medium">Carregando SunPeryo...</p>
        </div>

        <!-- TELAS DE AUTENTICAÇÃO -->
        <div id="auth-container" class="hidden">
            <div id="login-screen" class="p-8 h-screen flex flex-col justify-center bg-white text-gray-800">
                <div class="text-center mb-10">
                    <h1 class="text-5xl font-bold text-blue-600">SunPeryo</h1>
                    <p class="text-gray-500">Segurança e controle na sua mão.</p>
                </div>
                <div class="space-y-4">
                    <input id="email-input" type="email" placeholder="Email" class="w-full px-4 py-3 rounded-lg bg-gray-100 text-gray-800 border-2 border-gray-200 focus:border-blue-500 focus:bg-white focus:ring-0">
                    <input id="password-input" type="password" placeholder="Senha" class="w-full px-4 py-3 rounded-lg bg-gray-100 text-gray-800 border-2 border-gray-200 focus:border-blue-500 focus:bg-white focus:ring-0">
                </div>
                <button id="login-button" class="w-full mt-8 bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-all shadow-lg shadow-blue-600/30 transform hover:scale-105">Entrar</button>
                <p id="login-error" class="text-red-500 text-center mt-4 hidden"></p>
                <p class="text-center text-gray-500 mt-6">
                    Não tem uma conta? 
                    <button id="go-to-signup-button" class="font-semibold text-blue-600 hover:underline">Cadastre-se</button>
                </p>
            </div>
            
            <div id="signup-screen" class="hidden p-8 h-screen flex flex-col justify-center bg-white text-gray-800">
                 <div class="text-center mb-10">
                    <h1 class="text-4xl font-bold text-blue-600">Criar Conta</h1>
                    <p class="text-gray-500">Preencha para se registrar</p>
                </div>
                <div class="space-y-4">
                    <input id="signup-name-input" type="text" placeholder="Nome Completo" class="w-full px-4 py-3 rounded-lg bg-gray-100 text-gray-800 border-2 border-gray-200 focus:border-blue-500 focus:bg-white focus:ring-0">
                    <input id="signup-email-input" type="email" placeholder="Email" class="w-full px-4 py-3 rounded-lg bg-gray-100 text-gray-800 border-2 border-gray-200 focus:border-blue-500 focus:bg-white focus:ring-0">
                    <input id="signup-password-input" type="password" placeholder="Senha (mínimo 6 caracteres)" class="w-full px-4 py-3 rounded-lg bg-gray-100 text-gray-800 border-2 border-gray-200 focus:border-blue-500 focus:bg-white focus:ring-0">
                </div>
                <button id="signup-button" class="w-full mt-8 bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-all shadow-lg shadow-blue-600/30 transform hover:scale-105">Cadastrar</button>
                <p id="signup-error" class="text-red-500 text-center mt-4 hidden"></p>
                <p class="text-center text-gray-500 mt-6">
                    Já tem uma conta? 
                    <button id="go-to-login-button" class="font-semibold text-blue-600 hover:underline">Faça Login</button>
                </p>
            </div>
        </div>

        <!-- CONTAINER PRINCIPAL DO APP (PÓS-LOGIN) -->
        <div id="main-app-container" class="hidden">
            <header class="bg-white/80 backdrop-blur-sm text-gray-800 p-4 flex justify-between items-center shadow-md fixed top-0 w-full max-w-lg z-20">
                <button id="menu-button" class="p-2 text-gray-600 hover:text-blue-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
                <h1 id="header-title" class="text-xl font-bold">Dashboard</h1>
                <div class="w-10"></div> <!-- Espaçador -->
            </header>

            <main id="main-content" class="pt-20 pb-24 px-6 bg-gray-100 min-h-screen text-gray-800">
                <!-- TELA DASHBOARD VIGILANTE -->
                <div id="guard-dashboard-screen">
                    <div id="status-bar" class="p-3 mb-6 rounded-lg text-center font-semibold text-sm"></div>
                    <div class="mb-8">
                        <h2 class="text-3xl font-bold">Olá, <span id="user-name-guard"></span>!</h2>
                        <p class="text-gray-500">Selecione uma ação para sua ronda.</p>
                    </div>
                    <div class="space-y-4">
                        <button id="scan-qr-button" class="w-full bg-white text-gray-800 p-4 rounded-xl flex items-center gap-4 hover:bg-gray-200 transition-all transform hover:scale-105 shadow-md border">
                            <div class="p-3 bg-blue-100 rounded-lg">
                                <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/></svg>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg text-left">Escanear QR Code</h3>
                                <p class="text-gray-500 text-sm text-left">Registre um ponto escaneando o código.</p>
                            </div>
                        </button>
                        <button id="take-photo-button" class="w-full bg-white text-gray-800 p-4 rounded-xl flex items-center gap-4 hover:bg-gray-200 transition-all transform hover:scale-105 shadow-md border">
                           <div class="p-3 bg-blue-100 rounded-lg">
                                <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                           </div>
                           <div>
                                <h3 class="font-bold text-lg text-left">Tirar Foto do Local</h3>
                                <p class="text-gray-500 text-sm text-left">Capture uma imagem como comprovante.</p>
                           </div>
                        </button>
                    </div>
                     <div class="mt-8 p-4 bg-white rounded-lg border">
                        <h3 class="font-bold mb-2 text-gray-600">Último Registro</h3>
                        <div id="last-round-info" class="text-gray-500">Nenhum registro hoje.</div>
                    </div>
                    <div id="sync-status" class="text-center text-gray-500 text-sm mt-4"></div>
                </div>

                <!-- TELA HISTÓRICO VIGILANTE -->
                <div id="guard-history-screen" class="hidden">
                     <div id="guard-history-list" class="space-y-3">
                        <!-- Conteúdo do histórico do vigilante será inserido aqui -->
                     </div>
                </div>

                <!-- TELA DASHBOARD ADMIN -->
                <div id="admin-dashboard-screen" class="hidden">
                    <div class="relative mb-4">
                        <input id="search-user-input" type="text" placeholder="Buscar por nome ou email..." class="w-full pl-10 pr-4 py-2 rounded-lg bg-white text-gray-800 border-2 border-gray-200 focus:border-blue-500 focus:ring-0">
                        <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    <div id="users-list" class="space-y-3">
                        <div class="space-y-3 animate-pulse">
                            <div class="h-16 bg-gray-200 rounded-lg"></div>
                            <div class="h-16 bg-gray-200 rounded-lg"></div>
                            <div class="h-16 bg-gray-200 rounded-lg"></div>
                        </div>
                    </div>
                </div>

                <!-- TELA DE PERFIL -->
                <div id="profile-screen" class="hidden">
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium text-gray-500">Nome</label>
                            <input id="profile-name-input" type="text" class="w-full mt-1 px-4 py-3 rounded-lg bg-white text-gray-800 border-2 border-gray-200 focus:border-blue-500 focus:ring-0">
                        </div>
                         <div>
                            <label class="text-sm font-medium text-gray-500">Email</label>
                            <p id="profile-email-display" class="w-full mt-1 px-4 py-3 text-gray-600"></p>
                        </div>
                         <div>
                            <label class="text-sm font-medium text-gray-500">Função</label>
                            <p id="profile-role-display" class="w-full mt-1 px-4 py-3 text-gray-600 capitalize"></p>
                        </div>
                    </div>
                    <button id="save-profile-button" class="w-full mt-8 bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-colors">Salvar Alterações</button>
                </div>
            </main>

            <!-- Menu Lateral -->
            <div id="menu-overlay" class="hidden fixed inset-0 bg-black bg-opacity-60 z-30"></div>
            <div id="side-menu" class="closed fixed top-0 left-0 h-full w-64 bg-white shadow-2xl z-40 p-6 flex flex-col text-gray-800">
                <h2 class="text-2xl font-bold mb-8 text-blue-600">SunPeryo</h2>
                <nav id="side-menu-nav" class="flex-grow">
                    <!-- Links do menu serão inseridos aqui dinamicamente -->
                </nav>
                <button id="logout-button" class="flex items-center gap-3 p-3 rounded-lg hover:bg-red-100 text-red-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    <span>Sair</span>
                </button>
            </div>

            <!-- Navegação Inferior (Apenas para Vigilante) -->
            <nav id="guard-bottom-nav" class="hidden fixed bottom-0 w-full max-w-lg bg-white/80 backdrop-blur-sm border-t border-gray-200 grid grid-cols-2 text-center text-gray-500 z-20">
                <button id="nav-guard-dashboard" class="bottom-nav-item p-3 active">
                    <svg class="w-7 h-7 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                    <span class="text-xs">Dashboard</span>
                </button>
                <button id="nav-guard-history" class="bottom-nav-item p-3">
                    <svg class="w-7 h-7 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <span class="text-xs">Minhas Rondas</span>
                </button>
            </nav>
            
            <!-- Câmera e QR Reader View (Overlay) -->
            <div id="camera-container" class="hidden fixed inset-0 bg-black z-50 flex flex-col justify-center items-center">
                <div id="qr-reader" class="w-full max-w-lg"></div>
                <video id="video-preview" autoplay playsinline class="hidden w-full h-auto"></video>
                <canvas id="photo-canvas" class="hidden"></canvas>
                <div class="absolute bottom-5 w-full px-5 flex gap-4">
                    <button id="capture-button" class="hidden w-full bg-green-500 text-white p-3 rounded-lg font-bold">Capturar</button>
                    <button id="cancel-camera-button" class="w-full bg-red-500 text-white p-3 rounded-lg font-bold">Cancelar</button>
                </div>
            </div>
        </div>

    </div>

    <!-- MODAL GENÉRICO -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
        <div id="modal-content" class="bg-white text-gray-800 rounded-lg shadow-xl w-full max-w-md max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <h3 id="modal-title" class="text-lg font-bold"></h3>
                <button id="modal-close-button" class="text-gray-400 hover:text-gray-800">&times;</button>
            </div>
            <div id="modal-body" class="p-6 overflow-y-auto bg-gray-50">
                <!-- Conteúdo do modal -->
            </div>
        </div>
    </div>
    
    <!-- MENSAGEM DE FEEDBACK (TOAST) -->
    <div id="toast" class="hidden fixed bottom-24 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg z-50">
        <p id="toast-message"></p>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, setPersistence, browserLocalPersistence, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, collection, query, where, getDocs, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURAÇÃO INICIAL ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { 
            apiKey: "AIzaSyAqBwCgVJR_fH_QisTQZiIJE9B-2JC93vk",
            authDomain: "sunperyo.firebaseapp.com",
            projectId: "sunperyo",
            storageBucket: "sunperyo.appspot.com", 
            messagingSenderId: "850650155716",
            appId: "1:850650155716:web:8bfb4799d92d701e421791"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'sunperyo-app';

        // Inicializa Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        setPersistence(auth, browserLocalPersistence);

        // --- ELEMENTOS DA UI ---
        const mainAppContainer = document.getElementById('main-app-container');
        const authContainer = document.getElementById('auth-container');
        const loadingScreen = document.getElementById('loading-screen');
        const headerTitle = document.getElementById('header-title');
        
        const screens = {
            login: document.getElementById('login-screen'),
            signup: document.getElementById('signup-screen'),
            guardDashboard: document.getElementById('guard-dashboard-screen'),
            guardHistory: document.getElementById('guard-history-screen'),
            adminDashboard: document.getElementById('admin-dashboard-screen'),
            profile: document.getElementById('profile-screen')
        };
        
        const guardBottomNav = document.getElementById('guard-bottom-nav');
        const sideMenu = document.getElementById('side-menu');
        const sideMenuNav = document.getElementById('side-menu-nav');
        const menuOverlay = document.getElementById('menu-overlay');
        const cameraContainer = document.getElementById('camera-container');
        const videoPreview = document.getElementById('video-preview');
        const photoCanvas = document.getElementById('photo-canvas');
        
        let qrScanner = null;
        let videoStream = null;

        // --- ESTADO DA APLICAÇÃO ---
        let currentUser = null;
        let userData = null;
        let mapInstance = null;
        let allUsers = [];

        // --- FUNÇÕES DE NAVEGAÇÃO E UI ---
        const navigateToScreen = (screenName, title) => {
            Object.values(screens).forEach(s => s.classList.add('hidden'));
            if (screens[screenName]) {
                screens[screenName].classList.remove('hidden');
                headerTitle.textContent = title;
            }
            closeSideMenu();
        };

        const showToast = (message, isError = false) => {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            toast.className = `fixed bottom-24 left-1/2 -translate-x-1/2 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-opacity duration-300 ${isError ? 'bg-red-600' : 'bg-gray-800'}`;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        };

        const openModal = (title, contentHtml) => {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').innerHTML = contentHtml;
            document.getElementById('modal').classList.remove('hidden');
        };

        const closeModal = () => {
            document.getElementById('modal').classList.add('hidden');
            if (mapInstance) {
                mapInstance.remove();
                mapInstance = null;
            }
            const searchInput = document.getElementById('search-user-input');
            if(searchInput && searchInput.value) {
                searchInput.value = '';
                renderUsersList(allUsers);
            }
        };
        
        const openSideMenu = () => {
            sideMenu.classList.remove('closed');
            sideMenu.classList.add('open');
            menuOverlay.classList.remove('hidden');
            menuOverlay.style.opacity = '1';
        };

        const closeSideMenu = () => {
            sideMenu.classList.remove('open');
            sideMenu.classList.add('closed');
            menuOverlay.style.opacity = '0';
            setTimeout(() => menuOverlay.classList.add('hidden'), 300);
        };

        // --- LÓGICA DE AUTENTICAÇÃO ---
        onAuthStateChanged(auth, async (user) => {
            loadingScreen.classList.remove('hidden');
            authContainer.classList.add('hidden');
            mainAppContainer.classList.add('hidden');

            if (user) {
                currentUser = user;
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);

                if (userDoc.exists()) {
                    userData = userDoc.data();
                    mainAppContainer.classList.remove('hidden');
                    updateSideMenu(); // Atualiza o menu lateral com base na função do usuário
                    if (userData.role === 'admin') {
                        guardBottomNav.classList.add('hidden');
                        navigateToScreen('adminDashboard', 'Painel Admin');
                        loadUsers();
                    } else {
                        guardBottomNav.classList.remove('hidden');
                        navigateToScreen('guardDashboard', 'Dashboard');
                        document.getElementById('user-name-guard').textContent = userData.name || 'Vigilante';
                        updateOnlineStatus();
                        loadLastRound();
                    }
                } else {
                    console.error("Documento do usuário não encontrado. Deslogando.");
                    await signOut(auth);
                }
            } else {
                currentUser = null;
                userData = null;
                authContainer.classList.remove('hidden');
                screens.signup.classList.add('hidden');
                screens.login.classList.remove('hidden');
            }
            loadingScreen.classList.add('hidden');
        });

        // --- LÓGICA DO VIGILANTE ---
        const updateOnlineStatus = () => {
            const isOnline = navigator.onLine;
            const statusBar = document.getElementById('status-bar');
            statusBar.textContent = isOnline ? 'Conectado à internet' : 'Offline - Rondas salvas localmente';
            statusBar.className = `p-3 mb-6 rounded-lg text-center font-semibold text-sm ${isOnline ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`;
            if (isOnline) syncOfflineRounds();
        };
        
        const loadLastRound = async () => {
            const infoDiv = document.getElementById('last-round-info');
            try {
                const q = query(collection(db, `artifacts/${appId}/users/${currentUser.uid}/rounds`));
                const querySnapshot = await getDocs(q);
                let lastRound = null;
                querySnapshot.forEach(doc => {
                    const round = doc.data();
                    if(!lastRound || round.timestamp.seconds > lastRound.timestamp.seconds) {
                        lastRound = round;
                    }
                });

                if(lastRound) {
                    const time = lastRound.timestamp.toDate().toLocaleTimeString('pt-BR');
                    const type = lastRound.photoBase64 ? 'Foto' : `QR: ${lastRound.qrData}`;
                    infoDiv.innerHTML = `<p><span class="font-bold">${time}</span> - ${type}</p>`;
                } else {
                    infoDiv.innerHTML = 'Nenhum registro encontrado.';
                }
            } catch (e) {
                console.error("Error loading last round:", e);
                infoDiv.innerHTML = 'Erro ao carregar registros.';
            }
        };

        const startCamera = async (mode) => {
            cameraContainer.classList.remove('hidden');
            try {
                if (mode === 'photo') {
                    videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
                    videoPreview.srcObject = videoStream;
                    videoPreview.play();
                    videoPreview.classList.remove('hidden');
                    document.getElementById('capture-button').classList.remove('hidden');
                } else if (mode === 'qr') {
                    qrScanner = new Html5Qrcode("qr-reader");
                    const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                    await qrScanner.start({ facingMode: "environment" }, config, onQrScanSuccess, (err) => {});
                }
            } catch (err) {
                showToast("Não foi possível acessar a câmera.", true);
                stopCamera();
            }
        };

        const stopCamera = () => {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            if (qrScanner && qrScanner.isScanning) {
                qrScanner.stop().catch(err => {});
            }
            cameraContainer.classList.add('hidden');
            videoPreview.classList.add('hidden');
            document.getElementById('capture-button').classList.add('hidden');
        };
        
        const onQrScanSuccess = (decodedText) => {
            stopCamera();
            showToast(`QR Code lido: ${decodedText}`);
            saveRound({ qrData: decodedText });
        };

        const resizeAndCompressImage = (canvas, maxWidth, quality) => {
            const width = canvas.width;
            const height = canvas.height;

            if (width <= maxWidth) {
                return canvas.toDataURL('image/jpeg', quality);
            }

            const newHeight = height * (maxWidth / width);
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = maxWidth;
            tempCanvas.height = newHeight;
            const ctx = tempCanvas.getContext('2d');
            ctx.drawImage(canvas, 0, 0, maxWidth, newHeight);
            return tempCanvas.toDataURL('image/jpeg', quality);
        };

        const capturePhoto = () => {
            const context = photoCanvas.getContext('2d');
            photoCanvas.width = videoPreview.videoWidth;
            photoCanvas.height = videoPreview.videoHeight;
            context.drawImage(videoPreview, 0, 0, photoCanvas.width, photoCanvas.height);
            stopCamera();
            
            const photoBase64 = resizeAndCompressImage(photoCanvas, 1024, 0.7);
            saveRound({ photoBase64 });
        };
        
        const saveRound = (data) => {
             showToast("Obtendo localização...");
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const roundData = {
                        userId: currentUser.uid,
                        timestamp: new Date().toISOString(),
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        ...data
                    };
                    if (navigator.onLine) {
                        try {
                            showToast("Salvando ronda...");
                            const docToSave = { ...roundData, timestamp: new Date(roundData.timestamp) };
                            await addDoc(collection(db, `artifacts/${appId}/users/${currentUser.uid}/rounds`), docToSave);
                            showToast("Ronda salva com sucesso!", false);
                            loadLastRound();
                        } catch (error) {
                            console.error("Erro ao salvar online, salvando localmente:", error);
                            showToast("Falha ao salvar online. Ronda salva localmente.", true);
                            saveRoundLocally(roundData);
                        }
                    } else {
                        saveRoundLocally(roundData);
                    }
                },
                () => showToast("Não foi possível obter a localização.", true),
                { enableHighAccuracy: true }
            );
        };
        
        const saveRoundLocally = (roundData) => {
            const offlineRounds = JSON.parse(localStorage.getItem(`offlineRounds_${appId}`)) || [];
            offlineRounds.push(roundData);
            localStorage.setItem(`offlineRounds_${appId}`, JSON.stringify(offlineRounds));
            showToast('Ronda salva localmente!', false);
        };
        
        const syncOfflineRounds = async () => {
            const offlineRounds = JSON.parse(localStorage.getItem(`offlineRounds_${appId}`)) || [];
            if (offlineRounds.length === 0) return;

            showToast(`Sincronizando ${offlineRounds.length} ronda(s)...`);
            
            let successfullySynced = 0;
            const remainingRounds = [...offlineRounds];

            for (let i = 0; i < offlineRounds.length; i++) {
                const round = offlineRounds[i];
                try {
                    const roundDoc = { ...round, timestamp: new Date(round.timestamp) };
                    await addDoc(collection(db, `artifacts/${appId}/users/${round.userId}/rounds`), roundDoc);
                    
                    remainingRounds.shift();
                    successfullySynced++;
                } catch (error) {
                    console.error("Erro ao sincronizar ronda, tentando novamente mais tarde:", error);
                    break; 
                }
            }

            localStorage.setItem(`offlineRounds_${appId}`, JSON.stringify(remainingRounds));
            if (successfullySynced > 0) {
                showToast(`${successfullySynced} ronda(s) sincronizada(s)!`);
            }
        };

        // --- LÓGICA DO HISTÓRICO DO VIGILANTE ---
        const loadGuardHistory = async () => {
            const historyListDiv = document.getElementById('guard-history-list');
            historyListDiv.innerHTML = '<div class="flex justify-center items-center p-8"><span class="loader"></span></div>';
            await showRoundsForUser(currentUser.uid, 'Minhas Rondas', historyListDiv);
        };

        // --- LÓGICA DO ADMIN E GERAL ---
        const loadUsers = async () => {
            try {
                const q = query(collection(db, `users`), where("role", "==", "guard"));
                const querySnapshot = await getDocs(q);
                allUsers = querySnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderUsersList(allUsers);
            } catch (error) {
                document.getElementById('users-list').innerHTML = '<p class="text-red-500">Erro ao carregar vigilantes.</p>';
            }
        };
        
        const renderUsersList = (users) => {
            const usersListDiv = document.getElementById('users-list');
            if (users.length === 0) {
                usersListDiv.innerHTML = '<p class="text-gray-500">Nenhum vigilante encontrado.</p>';
                return;
            }
            usersListDiv.innerHTML = users.map(user => `
                <div class="bg-white p-4 rounded-lg flex justify-between items-center cursor-pointer hover:bg-gray-200 border" data-userid="${user.id}" data-username="${user.name || user.email}">
                    <div>
                        <p class="font-semibold text-gray-800">${user.name || 'Nome não definido'}</p>
                        <p class="text-sm text-gray-500">${user.email}</p>
                    </div>
                    <span class="text-blue-500 font-medium">&rarr;</span>
                </div>
            `).join('');
            
            usersListDiv.querySelectorAll('[data-userid]').forEach(el => {
                el.addEventListener('click', () => {
                    openModal(`Rondas de ${el.dataset.username}`, '');
                    showRoundsForUser(el.dataset.userid, el.dataset.username, document.getElementById('modal-body'));
                });
            });
        };
        
        const showRoundsForUser = async (userId, title, container) => {
            container.innerHTML = '<div class="flex justify-center items-center p-8"><span class="loader"></span></div>';
            try {
                const roundsPath = `artifacts/${appId}/users/${userId}/rounds`;
                const q = query(collection(db, roundsPath));
                const querySnapshot = await getDocs(q);

                if(querySnapshot.empty) {
                    container.innerHTML = '<p class="text-center text-gray-500">Nenhuma ronda encontrada.</p>';
                    return;
                }

                const roundsByDate = {};
                querySnapshot.forEach(doc => {
                    const round = { id: doc.id, ...doc.data() };
                    const date = round.timestamp.toDate().toLocaleDateString('pt-BR', { year: 'numeric', month: 'long', day: 'numeric' });
                    if (!roundsByDate[date]) {
                        roundsByDate[date] = [];
                    }
                    roundsByDate[date].push(round);
                });

                let datesHtml = '<div class="space-y-2">';
                const sortedDates = Object.keys(roundsByDate).sort((a, b) => new Date(b.split('/').reverse().join('-')) - new Date(a.split('/').reverse().join('-')));

                for (const date of sortedDates) {
                    datesHtml += `
                        <div class="bg-gray-100 p-3 rounded-md cursor-pointer hover:bg-gray-200 transition-colors" data-date-key="${date}">
                           <p class="font-semibold text-gray-700">${date} <span class="text-sm text-gray-500">(${roundsByDate[date].length} registros)</span></p>
                        </div>
                    `;
                }
                datesHtml += '</div>';
                
                container.innerHTML = datesHtml;

                container.querySelectorAll('[data-date-key]').forEach(el => {
                    el.addEventListener('click', () => {
                        const dateKey = el.dataset.dateKey;
                        showRoundsForDate(dateKey, roundsByDate[dateKey], title);
                    });
                });

            } catch (error) {
                container.innerHTML = '<p class="text-center text-red-500">Erro ao carregar rondas.</p>';
            }
        };
        
        const showRoundsForDate = (date, rounds, userName) => {
            openModal(`Registros de ${date}`, '<p class="text-center">Carregando...</p>');
            rounds.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);

            let timesHtml = '<div class="space-y-2">';
            rounds.forEach((round, index) => {
                const time = round.timestamp.toDate().toLocaleTimeString('pt-BR');
                const type = round.photoBase64 ? 'Foto' : 'QR Code';
                const details = round.photoBase64 ? 'Ponto registrado com foto' : `QR: ${round.qrData}`;
                timesHtml += `
                    <button class="w-full bg-white p-3 rounded-md flex justify-between items-center border text-left hover:bg-gray-200" data-round-index="${index}">
                        <div>
                            <p class="font-bold text-gray-800">${time}</p>
                            <p class="text-sm text-gray-500">${details}</p>
                        </div>
                        <span class="text-xs px-2 py-1 rounded-full ${round.photoBase64 ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800'}">${type}</span>
                    </button>
                `;
            });
            timesHtml += '</div>';
            
            timesHtml += `<button id="view-day-summary" class="w-full mt-6 bg-green-600 text-white font-bold py-2 rounded-lg hover:bg-green-700 transition-colors">Ver Resumo do Dia (Mapa)</button>`;

            document.getElementById('modal-body').innerHTML = timesHtml;
            
            // Adiciona listeners para cada registro individual
            document.querySelectorAll('[data-round-index]').forEach(el => {
                el.addEventListener('click', () => {
                    const round = rounds[parseInt(el.dataset.roundIndex)];
                    if (round.photoBase64) {
                        openModal('Foto da Ronda', `<img src="${round.photoBase64}" class="w-full h-auto rounded-lg">`);
                    } else {
                        openModal('Detalhe da Ronda', `<p class="text-gray-600">Registro de QR Code:</p><p class="font-bold text-lg mt-1">${round.qrData}</p>`);
                    }
                });
            });

            document.getElementById('view-day-summary').addEventListener('click', () => {
                showDaySummary(date, rounds, userName);
            });
        };

        const showDaySummary = (date, rounds, userName) => {
            openModal(`Resumo de ${date}`, '');
            
            let summaryHtml = '<div class="space-y-4">';
            summaryHtml += '<div><h4 class="font-bold mb-2">Mapa de Calor da Ronda</h4><div id="heatmap-container" class="rounded-lg bg-gray-200"></div></div>';
            
            const photos = rounds.filter(r => r.photoBase64);
            if(photos.length > 0) {
                summaryHtml += '<div><h4 class="font-bold mb-2">Fotos do Dia</h4><div class="grid grid-cols-2 sm:grid-cols-3 gap-2">';
                photos.forEach((p, index) => {
                    summaryHtml += `<img src="${p.photoBase64}" class="w-full h-32 object-cover rounded-lg shadow-md hover:opacity-80 transition-opacity cursor-pointer" data-photo-index="${index}">`;
                });
                summaryHtml += '</div></div>';
            }

            summaryHtml += '</div>';
            document.getElementById('modal-body').innerHTML = summaryHtml;

            document.querySelectorAll('[data-photo-index]').forEach(el => {
                el.addEventListener('click', () => {
                    const photo = photos[parseInt(el.dataset.photoIndex)];
                    openModal('Foto da Ronda', `<img src="${photo.photoBase64}" class="w-full h-auto rounded-lg">`);
                });
            });

            const locations = rounds.filter(r => r.latitude && r.longitude).map(r => [r.latitude, r.longitude, 0.8]);
            if (locations.length > 0) {
                const center = locations[0];
                setTimeout(() => {
                    try {
                        mapInstance = L.map('heatmap-container').setView([center[0], center[1]], 15);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                        }).addTo(mapInstance);
                        L.heatLayer(locations, {radius: 25, blur: 15, maxZoom: 17}).addTo(mapInstance);
                    } catch(e) {
                        document.getElementById('heatmap-container').innerHTML = `<p class="text-red-500 p-4">Erro ao renderizar o mapa.</p>`;
                    }
                }, 100);
            } else {
                document.getElementById('heatmap-container').innerHTML = '<p class="text-gray-500 p-4">Nenhum dado de localização para exibir no mapa.</p>';
            }
        };

        // --- LÓGICA DO MENU LATERAL ---
        const updateSideMenu = () => {
            let menuLinks = `
                <a href="#" id="nav-profile" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    <span>Meu Perfil</span>
                </a>
            `;
            if (userData.role === 'admin') {
                menuLinks = `
                    <a href="#" id="nav-admin-dashboard" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        <span>Dashboard</span>
                    </a>
                ` + menuLinks;
            }
            sideMenuNav.innerHTML = menuLinks;

            document.getElementById('nav-profile').addEventListener('click', (e) => {
                e.preventDefault();
                navigateToScreen('profile', 'Meu Perfil');
                document.getElementById('profile-name-input').value = userData.name || '';
                document.getElementById('profile-email-display').textContent = userData.email;
                document.getElementById('profile-role-display').textContent = userData.role;
            });
            
            if(userData.role === 'admin') {
                document.getElementById('nav-admin-dashboard').addEventListener('click', (e) => {
                    e.preventDefault();
                    navigateToScreen('adminDashboard', 'Painel Admin');
                });
            }
        };

        // --- EVENT LISTENERS ---
        // Auth
        document.getElementById('login-button').addEventListener('click', async () => {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                document.getElementById('login-error').textContent = "Email ou senha inválidos.";
                document.getElementById('login-error').classList.remove('hidden');
            }
        });
        
        document.getElementById('signup-button').addEventListener('click', async () => {
            const name = document.getElementById('signup-name-input').value;
            const email = document.getElementById('signup-email-input').value;
            const password = document.getElementById('signup-password-input').value;
            const errorP = document.getElementById('signup-error');
            
            if (!name || !email || password.length < 6) {
                errorP.textContent = "Preencha todos os campos corretamente.";
                errorP.classList.remove('hidden');
                return;
            }
            
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, "users", userCredential.user.uid), {
                    email: email,
                    name: name,
                    role: "guard"
                });
                showToast("Usuário cadastrado com sucesso!", false);
            } catch (error) {
                errorP.textContent = error.code === 'auth/email-already-in-use' ? "Este email já está em uso." : "Ocorreu um erro ao cadastrar.";
                errorP.classList.remove('hidden');
            }
        });

        document.getElementById('logout-button').addEventListener('click', () => signOut(auth));
        
        // Navegação
        document.getElementById('go-to-signup-button').addEventListener('click', () => {
            screens.login.classList.add('hidden');
            screens.signup.classList.remove('hidden');
        });
        document.getElementById('go-to-login-button').addEventListener('click', () => {
            screens.signup.classList.add('hidden');
            screens.login.classList.remove('hidden');
        });
        document.getElementById('menu-button').addEventListener('click', openSideMenu);
        menuOverlay.addEventListener('click', closeSideMenu);
        
        document.getElementById('save-profile-button').addEventListener('click', async () => {
            const newName = document.getElementById('profile-name-input').value;
            if (newName && newName !== userData.name) {
                try {
                    const userDocRef = doc(db, "users", currentUser.uid);
                    await updateDoc(userDocRef, { name: newName });
                    userData.name = newName;
                    if(userData.role === 'guard') {
                        document.getElementById('user-name-guard').textContent = newName;
                    }
                    showToast("Perfil atualizado com sucesso!");
                } catch (error) {
                    console.error("Erro ao atualizar perfil:", error);
                    showToast("Erro ao atualizar perfil. Verifique as regras de segurança.", true);
                }
            }
        });

        // Navegação Inferior do Vigilante
        const bottomNavItems = document.querySelectorAll('.bottom-nav-item');
        document.getElementById('nav-guard-dashboard').addEventListener('click', () => {
            bottomNavItems.forEach(item => item.classList.remove('active'));
            document.getElementById('nav-guard-dashboard').classList.add('active');
            navigateToScreen('guardDashboard', 'Dashboard');
        });

        document.getElementById('nav-guard-history').addEventListener('click', () => {
            bottomNavItems.forEach(item => item.classList.remove('active'));
            document.getElementById('nav-guard-history').classList.add('active');
            navigateToScreen('guardHistory', 'Minhas Rondas');
            loadGuardHistory();
        });

        // Câmera
        document.getElementById('take-photo-button').addEventListener('click', () => startCamera('photo'));
        document.getElementById('scan-qr-button').addEventListener('click', () => startCamera('qr'));
        document.getElementById('cancel-camera-button').addEventListener('click', stopCamera);
        document.getElementById('capture-button').addEventListener('click', capturePhoto);

        // Admin Search
        document.getElementById('search-user-input').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredUsers = allUsers.filter(user => user.email.toLowerCase().includes(searchTerm) || (user.name && user.name.toLowerCase().includes(searchTerm)));
            renderUsersList(filteredUsers);
        });

        // Modal
        document.getElementById('modal-close-button').onclick = closeModal;

        // Status Online/Offline
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
    </script>
</body>
</html>
