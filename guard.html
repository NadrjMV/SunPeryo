<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SunPeryo - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        :root {
            --primary-blue: #0A3D62;
            --accent-blue: #2980B9;
            --light-bg: #F7F9FC;
            --text-primary: #1A202C;
            --text-secondary: #5A6A7B;
            --border-color: #E2E8F0;
        }
        /* Correção definitiva para o "pull-to-refresh" no iOS */
        html, body {
            position: fixed;
            overflow: hidden;
            width: 100%;
            height: 100%;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--light-bg); }
        .logo-img { object-fit: contain; }
        .loader {
            width: 48px; height: 48px; border: 5px solid #d1d5db;
            border-bottom-color: var(--primary-blue); border-radius: 50%;
            display: inline-block; animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .bottom-nav-item.active svg, .bottom-nav-item.active span,
        .desktop-nav-item.active { 
            color: var(--primary-blue); 
            background-color: #EFF6FF;
            font-weight: 600;
        }
        .notification-dot {
            position: absolute; top: 0; right: 0; width: 10px; height: 10px;
            background-color: #EF4444; border-radius: 50%; border: 2px solid white;
        }
        /* Garante que o container principal seja o único com scroll */
        #main-app-container, #app-shell {
            height: 100vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body>
    <div id="loading-screen" class="h-screen flex flex-col justify-center items-center bg-white">
        <img src="https://i.postimg.cc/HngV6ftW/SUN-PLAN.png" alt="Logo Sun Plan" class="h-16 w-auto mb-4 logo-img">
        <span class="loader"></span>
        <p class="mt-4 text-lg font-medium text-[var(--text-secondary)]">Carregando...</p>
    </div>

    <div id="main-app-container" class="hidden">
        <div id="guard-desktop-layout" class="hidden lg:flex">
             <div class="w-64 bg-white shadow-md h-screen fixed top-0 left-0 p-6 flex flex-col">
                <img src="https://i.postimg.cc/HngV6ftW/SUN-PLAN.png" alt="Logo Sun Plan" class="h-12 w-auto mb-8 logo-img">
                <nav id="guard-desktop-nav" class="flex-grow space-y-2"></nav>
                <button id="logout-button-desktop" class="flex items-center gap-3 p-3 rounded-lg text-red-600 hover:bg-red-50 font-semibold mt-auto">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    <span>Sair da Conta</span>
                </button>
            </div>
            <div class="flex-1 lg:ml-64">
                <header class="bg-white/90 backdrop-blur-sm text-[var(--text-primary)] p-4 flex justify-between items-center shadow-sm sticky top-0 z-20 border-b border-[var(--border-color)]">
                    <h1 id="header-title-desktop" class="text-xl font-bold">Dashboard</h1>
                     <div class="relative">
                        <button id="notification-bell-desktop" class="hidden p-2 text-[var(--text-secondary)] hover:text-[var(--primary-blue)]">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                            <div id="notification-dot-desktop" class="hidden notification-dot"></div>
                        </button>
                    </div>
                </header>
                <main id="main-content-guard-desktop" class="p-8"></main>
            </div>
        </div>
        <div id="mobile-layout" class="lg:hidden">
            <div id="app-shell" class="max-w-lg mx-auto bg-[var(--light-bg)] min-h-screen shadow-2xl relative">
                <header class="bg-white/90 backdrop-blur-sm text-[var(--text-primary)] p-4 flex justify-between items-center shadow-sm fixed top-0 w-full max-w-lg z-20">
                    <button id="menu-button-mobile" class="p-2 text-[var(--text-secondary)] hover:text-[var(--primary-blue)]">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <h1 id="header-title-mobile" class="text-xl font-bold">Dashboard</h1>
                    <div class="w-10 relative">
                        <button id="notification-bell-mobile" class="hidden p-2 text-[var(--text-secondary)] hover:text-[var(--primary-blue)]">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                            <div id="notification-dot-mobile" class="hidden notification-dot"></div>
                        </button>
                    </div>
                </header>
                <main id="main-content-mobile" class="pt-24 pb-24 px-5 bg-[var(--light-bg)] min-h-screen text-[var(--text-primary)]"></main>
                <div id="menu-overlay" class="hidden fixed inset-0 bg-black bg-opacity-60 z-30"></div>
                <div id="side-menu-mobile" class="transition-transform transform -translate-x-full fixed top-0 left-0 h-full w-72 bg-white shadow-2xl z-40 p-6 flex flex-col text-[var(--text-primary)]">
                    <img src="https://i.postimg.cc/HngV6ftW/SUN-PLAN.png" alt="Logo Sun Plan" class="h-12 w-auto mb-8 logo-img">
                    <nav id="side-menu-nav-mobile" class="flex-grow space-y-2"></nav>
                    <button id="logout-button-mobile" class="flex items-center gap-3 p-3 rounded-lg text-red-600 hover:bg-red-50 font-semibold mt-auto">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        <span>Sair da Conta</span>
                    </button>
                </div>
                <nav id="bottom-nav" class="hidden fixed bottom-0 w-full max-w-lg bg-white/90 backdrop-blur-sm border-t border-[var(--border-color)] grid-cols-2 text-center text-[var(--text-secondary)] z-20"></nav>
            </div>
        </div>
        
        <div id="camera-container" class="hidden fixed inset-0 bg-black z-50 flex flex-col justify-center items-center">
            <div id="qr-reader" class="w-full max-w-lg"></div>
            <video id="video-preview" autoplay playsinline class="hidden w-full h-auto"></video>
            <canvas id="photo-canvas" class="hidden"></canvas>
            <div class="absolute bottom-5 w-full px-5 flex gap-4">
                <button id="capture-button" class="hidden w-full bg-green-500 text-white p-4 rounded-lg font-bold text-lg">Capturar</button>
                <button id="cancel-camera-button" class="w-full bg-red-500 text-white p-4 rounded-lg font-bold text-lg">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
        <div id="modal-content" class="bg-white text-[var(--text-primary)] rounded-xl shadow-xl w-full max-w-md max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-[var(--border-color)] flex justify-between items-center">
                <h3 id="modal-title" class="text-lg font-bold"></h3>
                <button id="modal-close-button" class="text-gray-400 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div id="modal-body" class="p-6 overflow-y-auto bg-[var(--light-bg)]"></div>
        </div>
    </div>
    
    <div id="toast" class="hidden fixed bottom-24 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-lg z-50">
        <p id="toast-message"></p>
    </div>

    <div id="screen-templates" class="hidden"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, collection, query, where, getDocs, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { 
            apiKey: "AIzaSyAqBwCgVJR_fH_QisTQZiIJE9B-2JC93vk",
            authDomain: "sunperyo.firebaseapp.com",
            projectId: "sunperyo",
            storageBucket: "sunperyo.appspot.com", 
            messagingSenderId: "850650155716",
            appId: "1:850650155716:web:8bfb4799d92d701e421791"
        };
        const appId = "sunperyo-app";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const mainAppContainer = document.getElementById('main-app-container');
        const loadingScreen = document.getElementById('loading-screen');
        const mobileLayout = document.getElementById('mobile-layout');
        const guardDesktopLayout = document.getElementById('guard-desktop-layout');
        const mainContentMobile = document.getElementById('main-content-mobile');
        const mainContentGuardDesktop = document.getElementById('main-content-guard-desktop');
        const headerTitleMobile = document.getElementById('header-title-mobile');
        const headerTitleDesktop = document.getElementById('header-title-desktop');
        const sideMenuMobile = document.getElementById('side-menu-mobile');
        const menuOverlay = document.getElementById('menu-overlay');
        const cameraContainer = document.getElementById('camera-container');
        const videoPreview = document.getElementById('video-preview');
        const photoCanvas = document.getElementById('photo-canvas');
        const modalOverlay = document.getElementById('modal-overlay');
        
        let qrScanner = null;
        let videoStream = null;
        let checkpoints = [];
        let currentUser = null;
        let userData = null;
        let mapInstance = null;
        let screens = {};
        let modalStack = [];

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists() && userDoc.data().role === 'guard') {
                    loadingScreen.classList.add('hidden');
                    mainAppContainer.classList.remove('hidden');
                    await startGuardApp(user, userDoc.data());
                } else {
                    window.location.replace('admin.html');
                }
            } else {
                window.location.replace('index.html');
            }
        });

        async function startGuardApp(user, data) {
            currentUser = user;
            userData = { id: user.uid, ...data };
            
            initializeTemplates();
            await loadCheckpoints();
            setupUI();
            requestInitialLocationPermission();
        }

        function initializeTemplates() {
            const templateContainer = document.getElementById('screen-templates');
            templateContainer.innerHTML = `
                <div id="guard-dashboard-screen"></div>
                <div id="guard-history-screen"></div>
                <div id="profile-screen"></div>
            `;
            screens = {
                guardDashboard: document.getElementById('guard-dashboard-screen'),
                guardHistory: document.getElementById('guard-history-screen'),
                profile: document.getElementById('profile-screen'),
            };
        }

        function setupUI() {
            const isDesktop = window.innerWidth >= 1024;
            guardDesktopLayout.classList.toggle('hidden', !isDesktop);
            mobileLayout.classList.toggle('hidden', isDesktop);
            
            updateNavigation();
            navigateToScreen('guardDashboard', 'Dashboard');
            loadGuardDashboard();
            checkForAlerts();

            document.getElementById('logout-button-mobile').addEventListener('click', () => signOut(auth));
            document.getElementById('logout-button-desktop').addEventListener('click', () => signOut(auth));
            document.getElementById('menu-button-mobile').addEventListener('click', openSideMenu);
            menuOverlay.addEventListener('click', closeSideMenu);
            document.getElementById('side-menu-nav-mobile').addEventListener('click', handleNavigation);
            document.getElementById('guard-desktop-nav').addEventListener('click', handleNavigation);
            document.getElementById('bottom-nav').addEventListener('click', handleNavigation);
            document.getElementById('modal-close-button').addEventListener('click', () => closeModal(true));
            modalOverlay.addEventListener('click', (e) => {
                if (e.target.id === 'modal-overlay') {
                    closeModal();
                }
            });
            document.getElementById('cancel-camera-button').addEventListener('click', stopCamera);
            document.getElementById('capture-button').addEventListener('click', capturePhoto);
            window.addEventListener('resize', () => { if(userData) setupUI() });
        }

        function navigateToScreen(screenName, title) {
            const isDesktop = window.innerWidth >= 1024;
            const contentContainer = isDesktop ? mainContentGuardDesktop : mainContentMobile;
            
            Object.values(screens).forEach(s => s.classList.add('hidden'));
            
            if (screens[screenName]) {
                contentContainer.innerHTML = '';
                contentContainer.appendChild(screens[screenName]);
                screens[screenName].classList.remove('hidden');
                headerTitleMobile.textContent = title;
                headerTitleDesktop.textContent = title;
            }
            closeSideMenu();
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            toast.className = `fixed bottom-24 left-1/2 -translate-x-1/2 text-white px-6 py-3 rounded-full shadow-lg z-50 transition-all duration-300 ${isError ? 'bg-red-600' : 'bg-gray-900'}`;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }
        
        function openModal(title, contentHtml, state = {}) {
            state.title = title;
            state.contentHtml = contentHtml;
            modalStack.push(state);
            renderCurrentModal();
        }

        function renderCurrentModal() {
            if (modalStack.length === 0) {
                modalOverlay.classList.add('hidden');
                if (mapInstance) {
                    mapInstance.remove(); mapInstance = null;
                }
                return;
            }
            const currentState = modalStack[modalStack.length - 1];
            document.getElementById('modal-title').textContent = currentState.title;
            const modalBody = document.getElementById('modal-body');
            if (currentState.renderer) {
                currentState.renderer(modalBody);
            } else {
                modalBody.innerHTML = currentState.contentHtml;
            }
            modalOverlay.classList.remove('hidden');
        }

        function closeModal(forceAll = false) {
            if (forceAll) {
                modalStack = [];
            } else if (modalStack.length > 0) {
                modalStack.pop();
            }
            renderCurrentModal();
        }
        
        function openSideMenu() {
            sideMenuMobile.classList.remove('-translate-x-full');
            menuOverlay.classList.remove('hidden');
            menuOverlay.style.opacity = '1';
        }

        function closeSideMenu() {
            sideMenuMobile.classList.add('-translate-x-full');
            menuOverlay.style.opacity = '0';
            setTimeout(() => menuOverlay.classList.add('hidden'), 300);
        }

        function loadGuardDashboard() {
            const isDesktop = window.innerWidth >= 1024;
            const container = isDesktop ? mainContentGuardDesktop : screens.guardDashboard;
            container.innerHTML = `
                <div class="mb-8 ${isDesktop ? '' : 'text-center lg:text-left'}">
                    <p class="text-[var(--text-secondary)] text-lg">Olá,</p>
                    <h2 class="text-4xl font-extrabold text-[var(--primary-blue)] -mt-1"><span id="user-name-guard">${userData.name.split(' ')[0]}</span>!</h2>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200/50 flex flex-col items-center mb-8 max-w-sm mx-auto">
                    <p class="font-bold text-[var(--text-secondary)]">Rondas Concluídas Hoje</p>
                    <p id="rounds-today-count" class="text-7xl font-extrabold text-[var(--primary-blue)] my-2">0</p>
                    <div id="status-bar" class="px-3 py-1 rounded-full text-center font-semibold text-sm"></div>
                </div>
                <div class="grid grid-cols-2 gap-4 max-w-sm mx-auto">
                    <button id="scan-qr-button" class="bg-white p-4 rounded-2xl flex flex-col items-center justify-center gap-2 hover:bg-gray-50 transition-all transform hover:-translate-y-1 shadow-md border border-[var(--border-color)]">
                        <div class="p-4 bg-blue-100 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" viewBox="0 0 24 24" class="text-[var(--primary-blue)]"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V6a2 2 0 0 1 2-2h2M4 16v2a2 2 0 0 0 2 2h2m8-12h2a2 2 0 0 1 2 2v2m-4 8h2a2 2 0 0 0 2-2v-2M7 12h10"></path></svg></div>
                        <h3 class="font-bold text-base text-center">Escanear QR</h3>
                    </button>
                    <button id="take-photo-button" class="bg-white p-4 rounded-2xl flex flex-col items-center justify-center gap-2 hover:bg-gray-50 transition-all transform hover:-translate-y-1 shadow-md border border-[var(--border-color)]">
                       <div class="p-4 bg-blue-100 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" viewBox="0 0 24 24" class="text-[var(--primary-blue)]"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 0 1 2-2h.93a2 2 0 0 0 1.664-.89l.812-1.22A2 2 0 0 1 10.07 4h3.86a2 2 0 0 1 1.664.89l.812 1.22A2 2 0 0 0 18.07 7H19a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9Z"></path><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"></path></svg></div>
                       <h3 class="font-bold text-base text-center">Tirar Foto</h3>
                    </button>
                </div>
                 <div class="mt-8 max-w-sm mx-auto">
                    <h3 class="font-bold mb-2 text-[var(--text-secondary)] text-lg text-center lg:text-left">Atividade Recente</h3>
                    <div id="last-round-info" class="space-y-2 text-[var(--text-primary)] font-medium"></div>
                    <div id="location-status-container" class="mt-4"></div>
                </div>`;
            container.querySelector('#take-photo-button').addEventListener('click', () => startCamera('photo'));
            container.querySelector('#scan-qr-button').addEventListener('click', () => startCamera('qr'));
            updateOnlineStatus();
            loadLastRound();
            checkAndRenderLocationStatus();
        }

        function updateOnlineStatus() {
            const statusBar = document.querySelector('#status-bar');
            if (!statusBar) return;
            const isOnline = navigator.onLine;
            statusBar.textContent = isOnline ? 'Online' : 'Offline';
            statusBar.className = `px-3 py-1 rounded-full text-center font-semibold text-sm ${isOnline ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`;
            if (isOnline) syncOfflineRounds();
        }
        
        async function loadLastRound() {
            const infoDiv = document.querySelector('#last-round-info');
            const roundsTodayCount = document.querySelector('#rounds-today-count');
            if (!infoDiv || !roundsTodayCount) return;
            infoDiv.innerHTML = '<div class="flex justify-center p-4"><span class="loader"></span></div>';
            try {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const q = query(collection(db, `artifacts/${appId}/users/${currentUser.uid}/rounds`), where("timestamp", ">=", today));
                const querySnapshot = await getDocs(q);
                const rounds = [];
                querySnapshot.forEach(doc => rounds.push(doc.data()));
                rounds.sort((a,b) => b.timestamp.seconds - a.timestamp.seconds);
                roundsTodayCount.textContent = rounds.length;
                if(rounds.length > 0) {
                    infoDiv.innerHTML = rounds.slice(0, 3).map(round => {
                        const time = round.timestamp.toDate().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                        const type = round.checkpointName || (round.photoBase64 ? 'Foto' : 'QR Avulso');
                        return `<div class="bg-white p-3 rounded-lg border border-[var(--border-color)] flex justify-between items-center"><span>${type}</span><span class="font-bold">${time}</span></div>`
                    }).join('');
                } else {
                    infoDiv.innerHTML = '<p class="text-center text-gray-500 p-4">Nenhum registro hoje.</p>';
                }
            } catch (e) {
                console.error("Error loading last round:", e);
                infoDiv.innerHTML = `<p class="text-center text-red-500 p-4">Erro ao carregar registros.</p>`;
            }
        }

        function renderLocationStatus(status) {
            const container = document.querySelector('#location-status-container');
            if (!container) return;
            let content = '';
            if (status === 'granted') {
                content = `
                    <div class="bg-green-100 border border-green-200 text-green-800 p-3 rounded-lg flex items-center justify-center text-sm">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <span>Status da Localização: <span class="font-bold">Ativa</span></span>
                    </div>`;
            } else if (status === 'denied') {
                content = `
                    <div class="p-4 bg-red-100 text-red-800 rounded-lg text-center border border-red-200">
                        <p class="font-bold">Localização Desativada (Obrigatório)</p>
                        <p class="text-sm mt-1">Você precisa permitir o acesso à localização nas configurações do seu navegador para registrar uma ronda.</p>
                        <button id="reattempt-location-btn" class="mt-3 bg-red-500 text-white font-bold py-2 px-4 rounded-lg text-sm w-full">Reativar Localização</button>
                    </div>`;
            } else { // prompt or default
                content = `
                    <div class="p-4 bg-blue-100 text-blue-800 rounded-lg text-center border border-blue-200">
                        <p class="font-bold">Permissão de Localização Pendente</p>
                        <p class="text-sm mt-1">A localização é necessária para registrar rondas. Clique no botão para ativar.</p>
                        <button id="reattempt-location-btn" class="mt-3 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg text-sm w-full">Ativar Localização</button>
                    </div>`;
            }
            container.innerHTML = content;
            if (status !== 'granted') {
                container.querySelector('#reattempt-location-btn').addEventListener('click', requestInitialLocationPermission);
            }
        }
        
        async function checkAndRenderLocationStatus() {
            if (navigator.permissions) {
                try {
                    const permissionStatus = await navigator.permissions.query({ name: 'geolocation' });
                    renderLocationStatus(permissionStatus.state);
                    permissionStatus.onchange = () => renderLocationStatus(permissionStatus.state);
                } catch (e) {
                    renderLocationStatus('default'); 
                }
            } else {
                renderLocationStatus('default');
            }
        }
        
        function requestInitialLocationPermission() {
             navigator.geolocation.getCurrentPosition(
                (position) => {
                    console.log("Localização obtida com sucesso na verificação inicial.");
                    checkAndRenderLocationStatus();
                },
                (error) => {
                    console.log("Falha ao obter localização na verificação inicial.");
                    checkAndRenderLocationStatus();
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        }

        async function startCamera(mode) {
            cameraContainer.classList.remove('hidden');
            try {
                if (mode === 'photo') {
                    videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
                    videoPreview.srcObject = videoStream;
                    videoPreview.play();
                    videoPreview.classList.remove('hidden');
                    document.getElementById('capture-button').classList.remove('hidden');
                } else if (mode === 'qr') {
                    qrScanner = new Html5Qrcode("qr-reader");
                    const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                    await qrScanner.start({ facingMode: "environment" }, config, onQrScanSuccess, (err) => {});
                }
            } catch (err) {
                showToast("Não foi possível acessar a câmera.", true);
                stopCamera();
            }
        }

        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            if (qrScanner && qrScanner.isScanning) {
                qrScanner.stop().catch(err => {});
            }
            cameraContainer.classList.add('hidden');
            videoPreview.classList.add('hidden');
            document.getElementById('capture-button').classList.add('hidden');
        }
        
        function onQrScanSuccess(decodedText) {
            stopCamera();
            const checkpoint = checkpoints.find(c => c.qrContent === decodedText);
            if (checkpoint) {
                showToast(`Ponto verificado: ${checkpoint.name}`);
                saveRound({ qrData: decodedText, checkpointName: checkpoint.name });
            } else {
                showToast("QR Code inválido ou não cadastrado.", true);
            }
        }

        function resizeAndCompressImage(canvas, maxWidth, quality) {
            const width = canvas.width;
            const height = canvas.height;
            if (width <= maxWidth) return canvas.toDataURL('image/jpeg', quality);
            const newHeight = height * (maxWidth / width);
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = maxWidth;
            tempCanvas.height = newHeight;
            tempCanvas.getContext('2d').drawImage(canvas, 0, 0, maxWidth, newHeight);
            return tempCanvas.toDataURL('image/jpeg', quality);
        }

        function capturePhoto() {
            const context = photoCanvas.getContext('2d');
            photoCanvas.width = videoPreview.videoWidth;
            photoCanvas.height = videoPreview.videoHeight;
            context.drawImage(videoPreview, 0, 0, photoCanvas.width, photoCanvas.height);
            stopCamera();
            const photoBase64 = resizeAndCompressImage(photoCanvas, 1024, 0.7);
            saveRound({ photoBase64 });
        }
        
        function saveRound(data) {
            showToast("Obtendo localização...");
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    checkAndRenderLocationStatus();
                    const roundData = {
                        userId: currentUser.uid,
                        userName: userData.name,
                        timestamp: new Date(),
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        ...data
                    };
                    if (navigator.onLine) {
                        try {
                            showToast("Salvando ronda...");
                            await addDoc(collection(db, `artifacts/${appId}/users/${currentUser.uid}/rounds`), roundData);
                            showToast("Ronda salva com sucesso!", false);
                            loadLastRound();
                        } catch (error) {
                            showToast("Falha na conexão. Ronda salva localmente.", true);
                            saveRoundLocally(roundData);
                        }
                    } else {
                        saveRoundLocally(roundData);
                    }
                },
                (error) => {
                    showToast("Não foi possível obter a localização.", true);
                    checkAndRenderLocationStatus();
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }
        
        function saveRoundLocally(roundData) {
            const offlineRounds = JSON.parse(localStorage.getItem(`offlineRounds_${appId}`)) || [];
            offlineRounds.push({...roundData, timestamp: roundData.timestamp.toISOString()});
            localStorage.setItem(`offlineRounds_${appId}`, JSON.stringify(offlineRounds));
            showToast('Ronda salva localmente!', false);
        }
        
        async function syncOfflineRounds() {
            const offlineRounds = JSON.parse(localStorage.getItem(`offlineRounds_${appId}`)) || [];
            if (offlineRounds.length === 0) return;
            showToast(`Sincronizando ${offlineRounds.length} ronda(s)...`);
            const remainingRounds = [...offlineRounds];
            let successCount = 0;
            for (const round of offlineRounds) {
                try {
                    const roundDoc = { ...round, timestamp: new Date(round.timestamp) };
                    await addDoc(collection(db, `artifacts/${appId}/users/${round.userId}/rounds`), roundDoc);
                    remainingRounds.shift();
                    successCount++;
                } catch (error) {
                    console.error("Erro ao sincronizar ronda:", error);
                    break; 
                }
            }
            localStorage.setItem(`offlineRounds_${appId}`, JSON.stringify(remainingRounds));
            if (successCount > 0) {
                showToast(`${successCount} ronda(s) sincronizada(s)!`);
                if(userData.role === 'guard') loadLastRound();
            }
        }

        async function loadGuardHistory() {
            await showRoundsForUser(currentUser.uid, screens.guardHistory);
        }

        async function showRoundsForUser(userId, container) {
            container.innerHTML = '<div class="flex justify-center items-center p-8"><span class="loader"></span></div>';
            try {
                const q = query(collection(db, `artifacts/${appId}/users/${userId}/rounds`));
                const querySnapshot = await getDocs(q);
                if(querySnapshot.empty) {
                    container.innerHTML = '<p class="text-center text-gray-500">Nenhuma ronda encontrada.</p>';
                    return;
                }
                const roundsByDate = {};
                querySnapshot.forEach(doc => {
                    const round = { id: doc.id, ...doc.data() };
                    const date = round.timestamp.toDate().toLocaleDateString('pt-BR', { year: 'numeric', month: 'long', day: 'numeric' });
                    if (!roundsByDate[date]) roundsByDate[date] = [];
                    roundsByDate[date].push(round);
                });
                let datesHtml = '<div class="space-y-2">';
                const sortedDates = Object.keys(roundsByDate).sort((a, b) => new Date(b.split(' de ')[2], b.split(' de ')[1], b.split(' de ')[0]) - new Date(a.split(' de ')[2], a.split(' de ')[1], a.split(' de ')[0]));
                for (const date of sortedDates) {
                    datesHtml += `
                        <div class="bg-white p-4 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors border border-[var(--border-color)]" data-date-key="${date}">
                           <p class="font-semibold text-[var(--text-primary)] flex justify-between items-center">${date} <span class="text-sm font-normal text-white bg-[var(--primary-blue)] px-2 py-0.5 rounded-full">${roundsByDate[date].length}</span></p>
                        </div>
                    `;
                }
                datesHtml += '</div>';
                container.innerHTML = datesHtml;
                container.querySelectorAll('[data-date-key]').forEach(el => {
                    el.addEventListener('click', () => {
                        const dateKey = el.dataset.dateKey;
                        openModal(`Registros de ${dateKey}`, null, {
                            renderer: (c) => showRoundsForDate(c, dateKey, roundsByDate[dateKey])
                        });
                    });
                });
            } catch (error) {
                container.innerHTML = `<p class="text-center text-red-500">Erro ao carregar rondas.</p>`;
            }
        }
        
        function showRoundsForDate(container, date, rounds) {
            rounds.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);
            let timesHtml = '<div class="space-y-2">';
            rounds.forEach((round, index) => {
                const time = round.timestamp.toDate().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                const typeIcon = round.photoBase64 
                    ? `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="text-blue-600"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 0 1 2-2h.93a2 2 0 0 0 1.664-.89l.812-1.22A2 2 0 0 1 10.07 4h3.86a2 2 0 0 1 1.664.89l.812 1.22A2 2 0 0 0 18.07 7H19a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9Z"></path><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"></path></svg>` 
                    : `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="text-purple-600"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V6a2 2 0 0 1 2-2h2M4 16v2a2 2 0 0 0 2 2h2m8-12h2a2 2 0 0 1 2 2v2m-4 8h2a2 2 0 0 0 2-2v-2M7 12h10"></path></svg>`;
                const details = round.checkpointName || (round.photoBase64 ? 'Foto do Local' : `QR: ${round.qrData}`);
                timesHtml += `
                    <button class="w-full bg-white p-3 rounded-lg flex justify-between items-center border border-[var(--border-color)] text-left hover:bg-gray-50" data-round-index="${index}">
                        <div class="flex items-center gap-3">
                            ${typeIcon}
                            <div>
                                <p class="font-bold text-[var(--text-primary)]">${time}</p>
                                <p class="text-sm text-[var(--text-secondary)]">${details}</p>
                            </div>
                        </div>
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                `;
            });
            timesHtml += '</div>';
            timesHtml += `<button id="view-day-summary" class="w-full mt-6 bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition-colors">Ver Resumo do Dia no Mapa</button>`;
            container.innerHTML = timesHtml;
            container.querySelectorAll('[data-round-index]').forEach(el => {
                el.addEventListener('click', () => {
                    const round = rounds[parseInt(el.dataset.roundIndex)];
                    if (round.photoBase64) {
                        openModal('Foto da Ronda', `<img src="${round.photoBase64}" class="w-full h-auto rounded-lg shadow-md">`);
                    } else {
                        openModal('Detalhe da Ronda', `<p class="text-[var(--text-secondary)]">Registro de QR Code:</p><p class="font-bold text-2xl mt-1">${round.qrData}</p>`);
                    }
                });
            });
            container.querySelector('#view-day-summary').addEventListener('click', () => {
                 openModal(`Resumo de ${date}`, null, {
                    renderer: (c) => showDaySummary(c, date, rounds)
                });
            });
        }

        function showDaySummary(container, date, rounds) {
            let summaryHtml = '<div class="space-y-4">';
            summaryHtml += '<div><h4 class="font-bold mb-2">Mapa de Calor da Ronda</h4><div id="heatmap-container" class="bg-gray-200 h-64 w-full rounded-lg"></div></div>';
            const photos = rounds.filter(r => r.photoBase64);
            if(photos.length > 0) {
                summaryHtml += '<div><h4 class="font-bold mb-2">Fotos do Dia</h4><div id="photo-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-2 mt-2">';
                photos.forEach((p, index) => {
                    summaryHtml += `<img src="${p.photoBase64}" class="w-full h-32 object-cover rounded-lg shadow-md hover:opacity-80 transition-opacity cursor-pointer" data-photo-index="${index}">`;
                });
                summaryHtml += '</div></div>';
            }
            summaryHtml += '</div>';
            container.innerHTML = summaryHtml;
            container.querySelectorAll('[data-photo-index]').forEach(el => {
                el.addEventListener('click', () => {
                    const photo = photos[parseInt(el.dataset.photoIndex)];
                    openModal('Foto da Ronda', `<img src="${photo.photoBase64}" class="w-full h-auto rounded-lg">`);
                });
            });
            
            const locations = rounds.filter(r => r.latitude && r.longitude).map(r => [r.latitude, r.longitude, 0.8]);
            if (locations.length > 0) {
                const center = locations[0];
                setTimeout(() => {
                    try {
                        const mapContainer = document.getElementById('heatmap-container');
                        if (mapContainer && !mapContainer._leaflet_id) {
                           mapInstance = L.map('heatmap-container').setView([center[0], center[1]], 15);
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                            }).addTo(mapInstance);
                            L.heatLayer(locations, {radius: 25, blur: 15, maxZoom: 17}).addTo(mapInstance);
                        }
                    } catch(e) {
                        console.error("Map rendering error:", e);
                        document.getElementById('heatmap-container').innerHTML = `<p class="text-red-500 p-4">Erro ao renderizar o mapa.</p>`;
                    }
                }, 100);
            } else {
                document.getElementById('heatmap-container').innerHTML = '<p class="text-gray-500 p-4 text-center">Nenhum dado de localização para exibir no mapa.</p>';
            }
        }

        async function loadCheckpoints() {
            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/checkpoints`));
                const querySnapshot = await getDocs(q);
                checkpoints = querySnapshot.docs.map(d => ({id: d.id, ...d.data()}));
            } catch (e) {
                console.error("Error loading checkpoints:", e);
                showToast("Erro ao carregar pontos de verificação.", true);
            }
        }

        function updateNavigation() {
            const guardNavItems = `
                <a href="#" data-nav="guardDashboard" class="desktop-nav-item flex items-center gap-4 p-3 rounded-lg hover:bg-gray-100 text-[var(--text-secondary)] font-semibold">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                    <span>Dashboard</span>
                </a>
                <a href="#" data-nav="guardHistory" class="desktop-nav-item flex items-center gap-4 p-3 rounded-lg hover:bg-gray-100 text-[var(--text-secondary)] font-semibold">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <span>Minhas Rondas</span>
                </a>
                <a href="#" data-nav="profile" class="desktop-nav-item flex items-center gap-4 p-3 rounded-lg hover:bg-gray-100 text-[var(--text-secondary)] font-semibold">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    <span>Meu Perfil</span>
                </a>
            `;
            document.getElementById('side-menu-nav-mobile').innerHTML = guardNavItems;
            document.getElementById('guard-desktop-nav').innerHTML = guardNavItems;
            
            const bottomNavEl = document.getElementById('bottom-nav');
            bottomNavEl.innerHTML = `
                <button data-nav="guardDashboard" class="bottom-nav-item p-3 active">
                    <svg class="w-7 h-7 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                    <span class="text-xs mt-1 block">Dashboard</span>
                </button>
                <button data-nav="guardHistory" class="bottom-nav-item p-3">
                    <svg class="w-7 h-7 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <span class="text-xs mt-1 block">Minhas Rondas</span>
                </button>
            `;
            bottomNavEl.classList.remove('hidden');
        }

        function handleNavigation(e) {
            e.preventDefault();
            const target = e.target.closest('[data-nav]');
            if (!target) return;
            const navTarget = target.dataset.nav;
            document.querySelectorAll('.bottom-nav-item, .desktop-nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll(`[data-nav=${navTarget}]`).forEach(item => item.classList.add('active'));
            
            const screenMap = {
                profile: { screen: 'profile', title: 'Meu Perfil', load: loadProfile },
                guardDashboard: { screen: 'guardDashboard', title: 'Dashboard', load: loadGuardDashboard },
                guardHistory: { screen: 'guardHistory', title: 'Minhas Rondas', load: loadGuardHistory },
            };
            
            if (screenMap[navTarget]) {
                const { screen, title, load } = screenMap[navTarget];
                navigateToScreen(screen, title);
                if (load) load();
            }
            closeSideMenu();
        }

        function loadProfile() {
            const isDesktop = window.innerWidth >= 1024;
            const container = isDesktop ? mainContentGuardDesktop : screens.profile;
            container.innerHTML = `
                <div class="space-y-6 max-w-md mx-auto">
                    <div>
                        <label class="text-sm font-medium text-[var(--text-secondary)]">Nome Completo</label>
                        <input id="profile-name-input" type="text" class="w-full mt-1 px-4 py-3 rounded-lg bg-white text-[var(--text-primary)] border-2 border-transparent focus:border-[var(--accent-blue)] focus:ring-0 transition-all shadow-sm">
                    </div>
                     <div>
                        <label class="text-sm font-medium text-[var(--text-secondary)]">Email</label>
                        <p id="profile-email-display" class="w-full mt-1 px-4 py-3 text-gray-600 bg-gray-100 rounded-lg"></p>
                    </div>
                     <div>
                        <label class="text-sm font-medium text-[var(--text-secondary)]">Função</label>
                        <p id="profile-role-display" class="w-full mt-1 px-4 py-3 text-gray-600 bg-gray-100 rounded-lg capitalize"></p>
                    </div>
                </div>
                <button id="save-profile-button" class="w-full mt-8 bg-[var(--primary-blue)] text-white font-bold py-3 rounded-lg hover:bg-[var(--accent-blue)] transition-colors max-w-md mx-auto block">Salvar Alterações</button>`;
            
            container.querySelector('#profile-name-input').value = userData.name || '';
            container.querySelector('#profile-email-display').textContent = userData.email;
            container.querySelector('#profile-role-display').textContent = userData.role;
            container.querySelector('#save-profile-button').addEventListener('click', async () => {
                const newName = container.querySelector('#profile-name-input').value;
                if (newName && newName !== userData.name) {
                    try {
                        const userDocRef = doc(db, "users", currentUser.uid);
                        await updateDoc(userDocRef, { name: newName });
                        userData.name = newName;
                        showToast("Perfil atualizado com sucesso!");
                        setupUI();
                    } catch (error) { showToast("Erro ao atualizar perfil.", true); }
                }
            });
        }

        async function checkForAlerts() {
            try {
                const alertDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/alerts`, "latest"));
                if (alertDoc.exists()) {
                    const alertData = alertDoc.data();
                    const lastReadTimestamp = localStorage.getItem(`lastAlertRead_${appId}`) || 0;
                    if (alertData.timestamp.seconds > lastReadTimestamp) {
                        const bells = document.querySelectorAll('#notification-bell-mobile, #notification-bell-desktop');
                        const dots = document.querySelectorAll('#notification-dot-mobile, #notification-dot-desktop');
                        bells.forEach(bell => {
                            bell.classList.remove('hidden');
                            bell.onclick = () => {
                                openModal('Último Alerta', `<p class="text-lg">${alertData.message}</p><p class="text-sm text-gray-500 mt-4">${alertData.timestamp.toDate().toLocaleString('pt-BR')}</p>`);
                                dots.forEach(dot => dot.classList.add('hidden'));
                                localStorage.setItem(`lastAlertRead_${appId}`, alertData.timestamp.seconds);
                            };
                        });
                        dots.forEach(dot => dot.classList.remove('hidden'));
                    }
                }
            } catch (error) {
                console.error("Error checking for alerts:", error);
            }
        }
    </script>
</body>
</html>
